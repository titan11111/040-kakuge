<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„Éû„É≥Ê†ºÈóò„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            position: fixed;
            width: 100%;
            height: 100%;
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
        }
        
        #gameContainer {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        #gameArea {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #2a4858 0%, #4a6878 50%, #3a3a3a 100%);
            width: 100%;
            height: 100%;
            margin: 0 auto;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            object-fit: contain;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            color: white;
            z-index: 10;
            pointer-events: none;
        }
        
        .health-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .player-info-left,
        .player-info-right {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 150px;
        }
        
        .player-info-right {
            align-items: flex-end;
        }
        
        .health-bar-wrapper {
            flex: 1;
            margin: 0 20px;
        }
        
        .health-bar {
            width: 100%;
            height: 30px;
            background: rgba(100, 0, 0, 0.8);
            border: 3px solid #fff;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            margin-bottom: 5px;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(to right, #ff0000, #ff6b00, #00ff00);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .guard-bar-wrapper {
            width: 100%;
        }
        
        .guard-bar {
            width: 100%;
            height: 8px;
            background: rgba(50, 50, 50, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }
        
        .guard-fill {
            height: 100%;
            background: linear-gradient(to right, #00ffff, #0088ff);
            transition: width 0.2s ease;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }
        
        .player-name {
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .player1-name {
            text-align: left;
        }
        
        .player2-name {
            text-align: right;
        }
        
        .combo-display {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(255, 215, 0, 0.8);
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .combo-display.active {
            opacity: 1;
        }
        
        #timer {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: auto;
        }
        
        #controllerArea {
            display: none;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            padding: 15px;
            box-sizing: border-box;
            position: relative;
        }
        
        .mobile-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 100%;
            pointer-events: auto;
            gap: 20px;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
            max-width: 50%;
        }
        
        .control-group.left {
            justify-content: flex-start;
        }
        
        .control-group.right {
            justify-content: flex-end;
        }
        
        /* ÂÜÜÂΩ¢„Ç≥„É≥„Éà„É≠„Éº„É©„ÉºÔºà„Ç¢„Éä„É≠„Ç∞„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÈ¢®Ôºâ */
        .circular-controller {
            position: relative;
            width: 140px;
            height: 140px;
            flex-shrink: 0;
        }
        
        .circular-controller-base {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 4px solid rgba(255, 255, 255, 0.5);
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        
        .circular-controller-stick {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.9);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease-out;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        .circular-controller.active .circular-controller-stick {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.6);
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .btn-row {
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.25);
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            transition: all 0.1s ease;
            position: relative;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
            text-align: center;
            line-height: 1.3;
            flex-shrink: 0;
        }
        
        .control-btn:active,
        .control-btn.touching {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.9);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }
        
        .restart-btn {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        
        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .restart-btn:active {
            transform: translateY(0);
        }
        
        #gameOver {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #fff;
            pointer-events: auto;
        }
        
        #gameOver h1 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
        }
        
        #gameOver p {
            font-size: 24px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            #controllerArea {
                display: block;
                height: 28vh;
                min-height: 180px;
                max-height: 250px;
            }
            
            #gameArea {
                height: 72vh;
                min-height: 0;
            }
            
            #controls .restart-btn {
                display: none;
            }
            
            .control-btn {
                width: 65px;
                height: 65px;
                font-size: 13px;
            }
            
            .dpad-container {
                width: 110px;
                height: 110px;
            }
            
            .dpad-btn {
                font-size: 22px;
            }
            
            #ui {
                padding: 8px;
            }
            
            .player-name {
                font-size: 14px;
            }
            
            #timer {
                font-size: 28px;
                top: 40px;
            }
            
            .health-bar {
                height: 20px;
            }
            
            .combo-display {
                font-size: 16px;
            }
        }
        
        /* iOSÂêë„Åë„ÅÆÁâπÂà•„Å™„Çπ„Çø„Ç§„É´ */
        @media (max-width: 768px) and (-webkit-min-device-pixel-ratio: 2) {
            #controllerArea {
                height: 30vh;
                min-height: 200px;
            }
            
            #gameArea {
                height: 70vh;
            }
            
            .control-btn {
                width: 68px;
                height: 68px;
                font-size: 13px;
            }
            
            .dpad-container {
                width: 115px;
                height: 115px;
            }
            
            .dpad-btn {
                font-size: 24px;
            }
            
            #controllerArea {
                padding: 18px;
            }
        }
        
        /* Â∞è„Åï„ÅÑÁîªÈù¢Âêë„Åë */
        @media (max-width: 480px) {
            #controllerArea {
                height: 30vh;
                min-height: 160px;
                max-height: 220px;
            }
            
            #gameArea {
                height: 70vh;
            }
            
            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 12px;
            }
            
            .dpad-container {
                width: 100px;
                height: 100px;
            }
            
            .dpad-btn {
                font-size: 20px;
            }
            
            .action-buttons {
                gap: 10px;
            }
            
            #controllerArea {
                padding: 12px;
            }
            
            #ui {
                padding: 6px;
            }
            
            .player-name {
                font-size: 12px;
            }
            
            #timer {
                font-size: 24px;
                top: 35px;
            }
            
            .health-bar {
                height: 18px;
            }
        }
        
        /* Ê®™Âêë„ÅçÔºà„É©„É≥„Éâ„Çπ„Ç±„Éº„ÉóÔºâÂêë„Åë - ÂÑ™ÂÖà„É¨„Ç§„Ç¢„Ç¶„Éà */
        @media (orientation: landscape) {
            #gameContainer {
                flex-direction: row;
            }
            
            #controllerArea {
                display: flex;
                width: auto;
                height: 100vh;
                min-width: 200px;
                max-width: 280px;
                border-top: none;
                border-left: 2px solid rgba(255, 255, 255, 0.2);
                padding: 20px 15px;
            }
            
            #gameArea {
                flex: 1;
                height: 100vh;
                min-width: 0;
            }
            
            .mobile-controls {
                flex-direction: column;
                justify-content: center;
                gap: 30px;
            }
            
            .control-group {
                flex-direction: column;
                max-width: 100%;
            }
            
            .control-group.left {
                justify-content: center;
                align-items: center;
            }
            
            .control-group.right {
                justify-content: center;
                align-items: center;
            }
            
            .circular-controller {
                width: 150px;
                height: 150px;
            }
            
            .control-btn {
                width: 80px;
                height: 80px;
                font-size: 14px;
            }
            
            .action-buttons {
                flex-direction: row;
                gap: 15px;
            }
            
            #ui {
                padding: 10px;
            }
            
            .health-bar {
                height: 18px;
            }
            
            .player-name {
                font-size: 14px;
            }
            
            #timer {
                font-size: 24px;
                top: 40px;
            }
        }
        
        /* Â∞è„Åï„ÅÑÊ®™ÁîªÈù¢Âêë„Åë */
        @media (max-height: 500px) and (orientation: landscape) {
            #controllerArea {
                min-width: 160px;
                max-width: 220px;
                padding: 10px;
            }
            
            .circular-controller {
                width: 120px;
                height: 120px;
            }
            
            .circular-controller-stick {
                width: 50px;
                height: 50px;
            }
            
            .control-btn {
                width: 65px;
                height: 65px;
                font-size: 12px;
            }
            
            .action-buttons {
                gap: 10px;
            }
            
            #ui {
                padding: 5px;
            }
            
            .health-bar {
                height: 16px;
            }
            
            .player-name {
                font-size: 12px;
            }
            
            #timer {
                font-size: 20px;
                top: 30px;
            }
        }
        
        #characterSelect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 100;
            pointer-events: auto;
            padding: 20px;
        }
        
        .select-container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        #characterSelect h1 {
            font-size: 48px;
            color: #fff;
            text-align: center;
            margin: 20px 0 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            font-weight: bold;
        }
        
        #characterSelect h2 {
            font-size: 28px;
            color: white;
            margin: 30px 0 15px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .player-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .player-section h3 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .character-card {
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .character-card:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #ffd700;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
        }
        
        .character-card.selected {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.15);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }
        
        .character-card h3 {
            font-size: 22px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .character-card .char-type {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .char-stats {
            font-size: 11px;
            color: #ccc;
            margin-top: 10px;
            line-height: 1.6;
        }
        
        .char-stats div {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        
        .char-stats .stat-label {
            color: #aaa;
        }
        
        .char-stats .stat-value {
            color: #fff;
            font-weight: bold;
        }
        
        .start-game-btn {
            padding: 18px 50px;
            font-size: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 30px auto;
            display: block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .start-game-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .start-game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .controls-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 30px auto;
            max-width: 1000px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .controls-info h3 {
            font-size: 24px;
            color: #fff;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .control-set {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-set h4 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #4af;
            text-align: center;
        }
        
        .control-set.p2 h4 {
            color: #f44;
        }
        
        .control-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-item:last-child {
            border-bottom: none;
        }
        
        .control-label {
            color: #ccc;
            font-size: 14px;
        }
        
        .control-key {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: bold;
            color: #fff;
            font-size: 14px;
            min-width: 40px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            #characterSelect h1 {
                font-size: 32px;
            }
            
            .character-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .character-card {
                padding: 15px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="characterSelect">
        <div class="select-container">
            <h1>‚öîÔ∏è „Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„Éû„É≥Ê†ºÈóò„Ç≤„Éº„É† ‚öîÔ∏è</h1>
            
            <div class="controls-info">
                <h3>üéÆ Êìç‰ΩúÊñπÊ≥ï</h3>
                <div class="controls-grid">
                    <div class="control-set">
                        <h4>„Éó„É¨„Ç§„É§„Éº1</h4>
                        <div class="control-item">
                            <span class="control-label">ÁßªÂãïÔºàÂ∑¶Âè≥Ôºâ</span>
                            <span class="control-key">‚Üê ‚Üí</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">„Ç∏„É£„É≥„Éó</span>
                            <span class="control-key">‚Üë</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">„Ç¨„Éº„Éâ</span>
                            <span class="control-key">‚Üì</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">„Éë„É≥„ÉÅ</span>
                            <span class="control-key">M</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">„Ç≠„ÉÉ„ÇØ</span>
                            <span class="control-key">N</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">ÂøÖÊÆ∫ÊäÄ</span>
                            <span class="control-key">B</span>
                        </div>
                    </div>
                    
                    <div class="control-set p2">
                        <h4>„Éó„É¨„Ç§„É§„Éº2</h4>
                        <div class="control-item">
                            <span class="control-label">ÁßªÂãïÔºàÂ∑¶Âè≥Ôºâ</span>
                            <span class="control-key">A D</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">„Ç∏„É£„É≥„Éó</span>
                            <span class="control-key">W</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">„Ç¨„Éº„Éâ</span>
                            <span class="control-key">S</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">„Éë„É≥„ÉÅ</span>
                            <span class="control-key">G</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">„Ç≠„ÉÉ„ÇØ</span>
                            <span class="control-key">H</span>
                        </div>
                        <div class="control-item">
                            <span class="control-label">ÂøÖÊÆ∫ÊäÄ</span>
                            <span class="control-key">J</span>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; color: #aaa; margin-top: 15px; font-size: 14px;">
                    „É¢„Éê„Ç§„É´Á´ØÊú´„Åß„ÅØ„ÄÅÁîªÈù¢‰∏ãÈÉ®„ÅÆ„Éú„Çø„É≥„ÅßÊìç‰Ωú„Åß„Åç„Åæ„Åô
                </p>
                
                <div style="margin-top: 25px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h4 style="color: #ffd700; margin-bottom: 15px; text-align: center; font-size: 18px;">üåü ÁâπÊÆäËÉΩÂäõ„Ç≥„Éû„É≥„Éâ üåü</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 13px; color: #ccc;">
        <div>
                            <strong style="color: #888;">Granite:</strong> ËøëË∑ùÈõ¢„Åß<span style="color: #fff; font-weight: bold;">‚Üì + „Éë„É≥„ÉÅ</span> = Êäï„ÅíÊäÄÔºàÈ´ò„ÉÄ„É°„Éº„Ç∏Ôºâ
                        </div>
                        <div>
                            <strong style="color: #ff4;">Zen:</strong> „Ç¨„Éº„ÉâÊàêÂäüÂæå„Å´<span style="color: #fff; font-weight: bold;">Ëá™Âãï„Ç´„Ç¶„É≥„Çø„Éº</span>Áô∫Âãï
                        </div>
                        <div>
                            <strong style="color: #4f4;">Universal:</strong> <span style="color: #fff; font-weight: bold;">ÁâπÊÆä„Ç≠„Éº + ‚Üê/‚Üí</span> = Á∑äÊÄ•ÂõûÈÅøÔºàÁÑ°ÊïµÊôÇÈñìÔºâ
                        </div>
                        <div>
                            <strong style="color: #f4f;">Mystia:</strong> ËøëË∑ùÈõ¢„Åß<span style="color: #fff; font-weight: bold;">‚Üë + „Ç≠„ÉÉ„ÇØ</span> = Êä±ÊìÅÊäÄ
                        </div>
                        <div>
                            <strong style="color: #0ff;">Cyber-K:</strong> „Ç≠„ÉÉ„ÇØ„ÅÆ<span style="color: #fff; font-weight: bold;">ÁØÑÂõ≤„Å®„ÉÄ„É°„Éº„Ç∏</span>„ÅåÂº∑Âåñ
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="player-section">
            <h3 style="color: #4af;">„Éó„É¨„Ç§„É§„Éº1</h3>
            <div class="character-grid" id="p1Select">
                <div class="character-card" data-char="ash">
                    <h3>Ash</h3>
                        <div class="char-type">„Çπ„Çø„É≥„ÉÄ„Éº„Éâ<br>„Éê„É©„É≥„ÇπÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="cyberK">
                    <h3>Cyber-K</h3>
                        <div class="char-type">„Éü„Éâ„É´„Ç≠„ÉÉ„ÇØ<br>„Çπ„Éî„Éº„ÉâÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="granite">
                    <h3>Granite</h3>
                        <div class="char-type">Êäï„ÅíÊäÄ<br>„Éë„ÉØ„ÉºÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="mystia">
                    <h3>Mystia</h3>
                        <div class="char-type">Êä±ÊìÅ&ËÜùËπ¥„Çä<br>„ÉÜ„ÇØ„Éã„ÉÉ„ÇØÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="zen">
                    <h3>Zen</h3>
                        <div class="char-type">„Ç´„Ç¶„É≥„Çø„Éº<br>Èò≤Âæ°Âûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="universal">
                    <h3>Universal</h3>
                        <div class="char-type">Á∑äÊÄ•ÂõûÈÅø<br>‰∏áËÉΩÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                </div>
            </div>
        </div>
            </div>
            
            <div class="player-section">
            <h3 style="color: #f44;">„Éó„É¨„Ç§„É§„Éº2</h3>
            <div class="character-grid" id="p2Select">
                <div class="character-card" data-char="ash">
                    <h3>Ash</h3>
                        <div class="char-type">„Çπ„Çø„É≥„ÉÄ„Éº„Éâ<br>„Éê„É©„É≥„ÇπÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="cyberK">
                    <h3>Cyber-K</h3>
                        <div class="char-type">„Éü„Éâ„É´„Ç≠„ÉÉ„ÇØ<br>„Çπ„Éî„Éº„ÉâÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="granite">
                    <h3>Granite</h3>
                        <div class="char-type">Êäï„ÅíÊäÄ<br>„Éë„ÉØ„ÉºÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="mystia">
                    <h3>Mystia</h3>
                        <div class="char-type">Êä±ÊìÅ&ËÜùËπ¥„Çä<br>„ÉÜ„ÇØ„Éã„ÉÉ„ÇØÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="zen">
                    <h3>Zen</h3>
                        <div class="char-type">„Ç´„Ç¶„É≥„Çø„Éº<br>Èò≤Âæ°Âûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                        </div>
                </div>
                <div class="character-card" data-char="universal">
                    <h3>Universal</h3>
                        <div class="char-type">Á∑äÊÄ•ÂõûÈÅø<br>‰∏áËÉΩÂûã</div>
                        <div class="char-stats">
                            <div><span class="stat-label">„Çπ„Éî„Éº„Éâ:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Éë„ÉØ„Éº:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                            <div><span class="stat-label">„Ç∏„É£„É≥„Éó:</span><span class="stat-value">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span></div>
                </div>
            </div>
        </div>
            </div>
            
            <button class="start-game-btn" id="startGameBtn" disabled>‚öîÔ∏è „Ç≤„Éº„É†ÈñãÂßã ‚öîÔ∏è</button>
        </div>
    </div>

    <div id="gameContainer">
        <div id="gameArea">
            <canvas id="gameCanvas"></canvas>
            
            <div id="ui">
        <div class="health-container">
            <div class="player-info-left">
            <div class="player-name player1-name" id="player1Name">„Éó„É¨„Ç§„É§„Éº1</div>
                <div class="combo-display" id="player1Combo"></div>
            </div>
            <div class="health-bar-wrapper">
                <div class="health-bar">
                    <div class="health-fill" id="player1Health" style="width: 100%"></div>
                </div>
                <div class="guard-bar-wrapper">
                    <div class="guard-bar">
                        <div class="guard-fill" id="player1Guard" style="width: 100%"></div>
                    </div>
                </div>
                <div class="super-gauge-wrapper">
                    <div class="super-gauge-container" id="player1SuperGauge">
                        <div class="super-gauge-segment empty"></div>
                        <div class="super-gauge-segment empty"></div>
                        <div class="super-gauge-segment empty"></div>
                    </div>
                </div>
            </div>
            <div id="timer">99</div>
            <div id="roundInfo" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); color: white; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); z-index: 1000; display: none;">
                <div id="roundText" style="font-size: 32px; margin-bottom: 5px;"></div>
                <div style="font-size: 18px; display: flex; gap: 20px; justify-content: center;">
                    <span id="player1Wins">0</span> - <span id="player2Wins">0</span>
                </div>
            </div>
            <div class="health-bar-wrapper">
                <div class="health-bar">
                    <div class="health-fill" id="player2Health" style="width: 100%"></div>
                </div>
                <div class="guard-bar-wrapper">
                    <div class="guard-bar">
                        <div class="guard-fill" id="player2Guard" style="width: 100%"></div>
            </div>
                </div>
                <div class="super-gauge-wrapper">
                    <div class="super-gauge-container" id="player2SuperGauge">
                        <div class="super-gauge-segment empty"></div>
                        <div class="super-gauge-segment empty"></div>
                        <div class="super-gauge-segment empty"></div>
                    </div>
                </div>
            </div>
            <div class="player-info-right">
                <div class="player-name player2-name" id="player2Name">„Éó„É¨„Ç§„É§„Éº2</div>
                <div class="combo-display" id="player2Combo"></div>
            </div>
        </div>
        </div>
    
        <div id="controls">
            <button class="restart-btn" onclick="location.reload()">„É™„Çπ„Çø„Éº„Éà</button>
        </div>
        </div>
        
        <div id="controllerArea">
            <div class="mobile-controls">
                <!-- Â∑¶ÂÅ¥ÔºöÂÜÜÂΩ¢„Ç≥„É≥„Éà„É≠„Éº„É©„ÉºÔºà„Ç¢„Éä„É≠„Ç∞„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÈ¢®Ôºâ -->
                <div class="control-group left">
                    <div class="circular-controller" id="p1CircularController">
                        <div class="circular-controller-base">
                            <div class="circular-controller-stick"></div>
                        </div>
                    </div>
                </div>
        
                <!-- Âè≥ÂÅ¥Ôºö„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                <div class="control-group right">
                    <div class="action-buttons">
                        <button class="control-btn" id="p1Punch">„Éë„É≥„ÉÅ</button>
                        <button class="control-btn" id="p1Kick">„Ç≠„ÉÉ„ÇØ</button>
                        <button class="control-btn" id="p1Special">ÂøÖÊÆ∫</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="gameOver">
        <h1 id="winnerText">PLAYER 1 WIN!</h1>
        <p id="winMethod"></p>
        <button class="restart-btn" onclick="location.reload()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë®≠ÂÆöÔºàiOSÂØæÂøúÂº∑Âåñ„Éª„É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøúÔºâ
        function resizeCanvas() {
            const gameArea = document.getElementById('gameArea');
            if (!gameArea) return;
            
            const areaWidth = gameArea.clientWidth;
            const areaHeight = gameArea.clientHeight;
            const aspectRatio = 16 / 9;
            
            let canvasWidth, canvasHeight;
            
            // „Ç≤„Éº„É†„Ç®„É™„Ç¢„ÅÆ„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Å¶„Ç≠„É£„É≥„Éê„Çπ„ÇíË®≠ÂÆö
            if (areaWidth / areaHeight > aspectRatio) {
                canvasHeight = areaHeight;
                canvasWidth = areaHeight * aspectRatio;
            } else {
                canvasWidth = areaWidth;
                canvasHeight = areaWidth / aspectRatio;
            }
            
            // ÊúÄÂ∞è„Çµ„Ç§„Ç∫Âà∂Èôê
            canvasWidth = Math.max(canvasWidth, 320);
            canvasHeight = Math.max(canvasHeight, 180);
            
            // „Ç≠„É£„É≥„Éê„Çπ„ÅÆÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆöÔºàÊèèÁîªËß£ÂÉèÂ∫¶Ôºâ
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Ë°®Á§∫„Çµ„Ç§„Ç∫„ÅØCSS„ÅßÂà∂Âæ°Ôºàflexbox„ÅßËá™ÂãïË™øÊï¥Ôºâ
        }
        
        // ÂàùÊúüÂåñ„Å®„É™„Çµ„Ç§„Ç∫Âá¶ÁêÜ
        function initLayout() {
            resizeCanvas();
        }
        
        initLayout();
        window.addEventListener('resize', () => {
            setTimeout(resizeCanvas, 50);
        });
        window.addEventListener('orientationchange', () => {
            setTimeout(resizeCanvas, 200); // iOS„ÅßÂêë„ÅçÂ§âÊõ¥Âæå„Å´Â∞ë„ÅóÈÅÖÂª∂
        });
        
        // „Ç≤„Éº„É†„Ç®„É™„Ç¢„ÅÆ„É™„Çµ„Ç§„Ç∫„ÇíÁõ£Ë¶ñ
        if (window.ResizeObserver) {
            const resizeObserver = new ResizeObserver(() => {
                resizeCanvas();
            });
            const gameArea = document.getElementById('gameArea');
            if (gameArea) {
                resizeObserver.observe(gameArea);
            }
        }
        
        // iOSÂêë„Åë„ÅÆ„Éì„É•„Éº„Éù„Éº„ÉàÈ´ò„ÅïË™øÊï¥
        function setVH() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setVH();
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', () => {
            setTimeout(setVH, 100);
        });
        
        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÂÆöÁæ©
        const characterData = {
            ash: {
                name: 'Ash',
                color: '#4af',
                speed: 5,
                jumpPower: 15,
                background: {
                    type: 'urban',
                    sky: ['#1a1a2e', '#16213e', '#0f3460'],
                    buildings: ['#2a2a3e', '#3a3a4e', '#4a4a5e'],
                    ground: '#1a1a1a',
                    theme: 'futuristic_city'
                },
                attacks: {
                    punch: { 
                        damage: 8, range: 60, startup: 5, recovery: 10,
                        cancelWindow: { start: 3, end: 7 }, // „Éí„ÉÉ„ÉàÂæå„Å´„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Å™„Éï„É¨„Éº„É†
                        cancellableInto: ['kick', 'special'] // „Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Å™ÊäÄ
                    },
                    kick: { 
                        damage: 12, range: 80, startup: 9, recovery: 15,
                        cancelWindow: { start: 6, end: 12 },
                        cancellableInto: ['special']
                    },
                    special: { 
                        damage: 25, range: 120, startup: 15, recovery: 30, name: 'Ultimate Impact',
                        cancelWindow: null,
                        cancellableInto: []
                    }
                },
                superMove: {
                    name: 'FINAL IMPACT',
                    damage: 45,
                    range: 150,
                    startup: 20,
                    recovery: 40,
                    gaugeCost: 200, // 2„Ç≤„Éº„Ç∏Ê∂àË≤ª
                    command: ['down', 'down', 'forward', 'forward', 'punch']
                }
            },
            cyberK: {
                name: 'Cyber-K',
                color: '#0ff',
                speed: 7,
                jumpPower: 18,
                background: {
                    type: 'cyber',
                    sky: ['#000428', '#004e92', '#009ffd'],
                    buildings: ['#00d4ff', '#0099cc', '#006699'],
                    ground: '#001a33',
                    theme: 'cyberpunk'
                },
                attacks: {
                    punch: { 
                        damage: 7, range: 55, startup: 3, recovery: 8,
                        cancelWindow: { start: 2, end: 5 },
                        cancellableInto: ['kick', 'special']
                    },
                    kick: { 
                        damage: 15, range: 100, startup: 8, recovery: 12,
                        cancelWindow: { start: 5, end: 10 },
                        cancellableInto: ['special']
                    },
                    special: { 
                        damage: 22, range: 110, startup: 10, recovery: 25, name: 'Middle Kick',
                        cancelWindow: null,
                        cancellableInto: []
                    }
                },
                superMove: {
                    name: 'CYBER STORM',
                    damage: 42,
                    range: 140,
                    startup: 18,
                    recovery: 35,
                    gaugeCost: 200,
                    command: ['down', 'forward', 'down', 'forward', 'kick']
                }
            },
            granite: {
                name: 'Granite',
                color: '#888',
                speed: 3,
                jumpPower: 10,
                background: {
                    type: 'mountain',
                    sky: ['#2c1810', '#3d2317', '#4a2c1f'],
                    buildings: ['#654321', '#8b4513', '#a0522d'],
                    ground: '#5a4a3a',
                    theme: 'rocky_mountain'
                },
                attacks: {
                    punch: { 
                        damage: 15, range: 70, startup: 8, recovery: 15,
                        cancelWindow: { start: 6, end: 11 },
                        cancellableInto: ['kick', 'special']
                    },
                    kick: { 
                        damage: 10, range: 60, startup: 10, recovery: 12,
                        cancelWindow: { start: 7, end: 13 },
                        cancellableInto: ['special']
                    },
                    special: { 
                        damage: 30, range: 80, startup: 20, recovery: 35, name: 'Granit Press',
                        cancelWindow: null,
                        cancellableInto: []
                    }
                },
                superMove: {
                    name: 'MOUNTAIN CRUSHER',
                    damage: 50,
                    range: 120,
                    startup: 25,
                    recovery: 45,
                    gaugeCost: 200,
                    command: ['down', 'down', 'down', 'punch']
                }
            },
            mystia: {
                name: 'Mystia',
                color: '#f4f',
                speed: 6,
                jumpPower: 16,
                background: {
                    type: 'mystical',
                    sky: ['#1a0033', '#330066', '#660099'],
                    buildings: ['#9933cc', '#cc66ff', '#ff99ff'],
                    ground: '#4d004d',
                    theme: 'magical_forest'
                },
                attacks: {
                    punch: { 
                        damage: 6, range: 50, startup: 4, recovery: 8,
                        cancelWindow: { start: 3, end: 6 },
                        cancellableInto: ['kick', 'special']
                    },
                    kick: { 
                        damage: 14, range: 70, startup: 7, recovery: 10,
                        cancelWindow: { start: 5, end: 9 },
                        cancellableInto: ['special']
                    },
                    special: { 
                        damage: 28, range: 90, startup: 12, recovery: 28, name: 'Mujihi na Hoyo',
                        cancelWindow: null,
                        cancellableInto: []
                    }
                },
                superMove: {
                    name: 'ETERNAL EMBRACE',
                    damage: 40,
                    range: 130,
                    startup: 15,
                    recovery: 30,
                    gaugeCost: 200,
                    command: ['down', 'forward', 'down', 'forward', 'kick']
                }
            },
            zen: {
                name: 'Zen',
                color: '#ff4',
                speed: 5,
                jumpPower: 14,
                background: {
                    type: 'temple',
                    sky: ['#ffeaa7', '#fdcb6e', '#e17055'],
                    buildings: ['#dfe6e9', '#b2bec3', '#636e72'],
                    ground: '#fab1a0',
                    theme: 'peaceful_temple'
                },
                attacks: {
                    punch: { 
                        damage: 10, range: 65, startup: 6, recovery: 12,
                        cancelWindow: { start: 4, end: 8 },
                        cancellableInto: ['kick', 'special']
                    },
                    kick: { 
                        damage: 11, range: 75, startup: 8, recovery: 13,
                        cancelWindow: { start: 6, end: 11 },
                        cancellableInto: ['special']
                    },
                    special: { 
                        damage: 20, range: 85, startup: 8, recovery: 20, name: 'Kuusemi-gaashi',
                        cancelWindow: null,
                        cancellableInto: []
                    }
                },
                superMove: {
                    name: 'TRANSCENDENT STRIKE',
                    damage: 38,
                    range: 125,
                    startup: 12,
                    recovery: 28,
                    gaugeCost: 200,
                    command: ['down', 'back', 'down', 'forward', 'punch']
                }
            },
            universal: {
                name: 'Universal',
                color: '#4f4',
                speed: 6,
                jumpPower: 15,
                background: {
                    type: 'space',
                    sky: ['#000000', '#1a0033', '#330066'],
                    buildings: ['#00ff88', '#00cc66', '#009944'],
                    ground: '#001a1a',
                    theme: 'cosmic_arena'
                },
                attacks: {
                    punch: { 
                        damage: 9, range: 60, startup: 5, recovery: 10,
                        cancelWindow: { start: 3, end: 7 },
                        cancellableInto: ['kick', 'special']
                    },
                    kick: { 
                        damage: 13, range: 75, startup: 8, recovery: 13,
                        cancelWindow: { start: 6, end: 11 },
                        cancellableInto: ['special']
                    },
                    special: { 
                        damage: 24, range: 100, startup: 12, recovery: 25, name: 'Emergency Step',
                        cancelWindow: null,
                        cancellableInto: []
                    }
                },
                superMove: {
                    name: 'COSMIC ANNIHILATION',
                    damage: 44,
                    range: 145,
                    startup: 16,
                    recovery: 32,
                    gaugeCost: 200,
                    command: ['down', 'forward', 'down', 'forward', 'special']
                }
            }
        };
        
        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû
        let selectedP1 = null;
        let selectedP2 = null;
        
        document.querySelectorAll('#p1Select .character-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('#p1Select .character-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedP1 = card.dataset.char;
                updateStartButton();
            });
        });
        
        document.querySelectorAll('#p2Select .character-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('#p2Select .character-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedP2 = card.dataset.char;
                updateStartButton();
            });
        });
        
        function updateStartButton() {
            const btn = document.getElementById('startGameBtn');
            if (selectedP1 && selectedP2) {
                btn.disabled = false;
            }
        }
        
        document.getElementById('startGameBtn').addEventListener('click', () => {
            // „É¶„Éº„Ç∂„ÉºÊìç‰ΩúÊôÇ„Å´AudioContext„ÇíÂàùÊúüÂåñ
            initAudioContexts();
            resumeAudioContexts();
            
            document.getElementById('characterSelect').style.display = 'none';
            initGame();
        });
        
        // „Ç≤„Éº„É†Â§âÊï∞
        let player1, player2;
        let keys = {};
        let gameRunning = false;
        let gameTime = 99;
        let lastTime = Date.now();
        
        // „É©„Ç¶„É≥„ÉâÂà∂„Ç∑„Çπ„ÉÜ„É†
        let currentRound = 1;
        let maxRounds = 3;
        let player1Wins = 0;
        let player2Wins = 0;
        let roundStarting = false;
        let roundStartFrames = 0;
        let roundStartMessage = '';
        
        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç∑„Çπ„ÉÜ„É†
        const particles = [];
        
        // „ÉÄ„É°„Éº„Ç∏Êï∞Â≠ó„Ç∑„Çπ„ÉÜ„É†
        const damageNumbers = [];
        
        // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´Ë°®Á§∫„Ç∑„Çπ„ÉÜ„É†
        const criticalTexts = [];
        
        // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ„Ç∑„Çπ„ÉÜ„É†
        let cameraShake = { x: 0, y: 0, frames: 0, intensity: 0 };
        
        // „Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É†
        let slowMotionActive = false;
        let slowMotionFrames = 0;
        let slowMotionSpeed = 1.0;
        
        // Èü≥ÈüøÂäπÊûú„Ç∑„Çπ„ÉÜ„É†Ôºà2„Å§„ÅÆAudioContext„Å´ÂàÜÈõ¢Ôºâ
        // ÂäπÊûúÈü≥Áî®„ÅÆAudioContext
        let seAudioContext = null;
        // BGMÁî®„ÅÆAudioContext
        let bgmAudioContext = null;
        
        // AudioContext„ÅÆÂàùÊúüÂåñÈñ¢Êï∞ÔºàiOSÂØæÂøúÂº∑ÂåñÔºâ
        function initAudioContexts() {
            try {
                if (!seAudioContext) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    seAudioContext = new AudioContextClass();
                    
                    // iOS Safari 13+Âêë„Åë„ÅÆË®≠ÂÆö
                    if (seAudioContext.state === 'suspended') {
                        seAudioContext.resume();
                    }
                }
                if (!bgmAudioContext) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    bgmAudioContext = new AudioContextClass();
                    
                    // iOS Safari 13+Âêë„Åë„ÅÆË®≠ÂÆö
                    if (bgmAudioContext.state === 'suspended') {
                        bgmAudioContext.resume();
                    }
                }
            } catch (e) {
                console.warn('AudioContextÂàùÊúüÂåñ„Ç®„É©„Éº:', e);
            }
        }
        
        // AudioContext„ÅÆÂæ©ÂÖÉÈñ¢Êï∞ÔºàiOSÂØæÂøúÂº∑ÂåñÔºâ
        function resumeAudioContexts() {
            try {
                if (seAudioContext) {
                    if (seAudioContext.state === 'suspended') {
                        seAudioContext.resume().catch(e => {
                            console.warn('SE AudioContextÂæ©ÂÖÉ„Ç®„É©„Éº:', e);
                        });
                    }
                }
                if (bgmAudioContext) {
                    if (bgmAudioContext.state === 'suspended') {
                        bgmAudioContext.resume().catch(e => {
                            console.warn('BGM AudioContextÂæ©ÂÖÉ„Ç®„É©„Éº:', e);
                        });
                    }
                }
            } catch (e) {
                console.warn('AudioContextÂæ©ÂÖÉ„Ç®„É©„Éº:', e);
            }
        }
        
        // iOSÂêë„ÅëÔºöÊúÄÂàù„ÅÆ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÊôÇ„Å´AudioContext„ÇíÂæ©ÂÖÉ
        function enableAudioOnFirstInteraction() {
            const enableAudio = () => {
                initAudioContexts();
                resumeAudioContexts();
                document.removeEventListener('touchstart', enableAudio);
                document.removeEventListener('click', enableAudio);
            };
            
            document.addEventListener('touchstart', enableAudio, { once: true });
            document.addEventListener('click', enableAudio, { once: true });
        }
        
        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´Ê∫ñÂÇô
        enableAudioOnFirstInteraction();
        
        // Èü≥ÈüøÂäπÊûúÁîüÊàêÈñ¢Êï∞ÔºàÂäπÊûúÈü≥Áî®AudioContext„Çí‰ΩøÁî®Ôºâ
        function playSound(frequency, duration, type = 'sine', volume = 0.3) {
            try {
                if (!seAudioContext) {
                    initAudioContexts();
                }
                if (seAudioContext.state === 'suspended') {
                    seAudioContext.resume();
                }
                
                const oscillator = seAudioContext.createOscillator();
                const gainNode = seAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(seAudioContext.destination);
                
                oscillator.type = type;
                oscillator.frequency.value = frequency;
                
                gainNode.gain.setValueAtTime(volume, seAudioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, seAudioContext.currentTime + duration);
                
                oscillator.start(seAudioContext.currentTime);
                oscillator.stop(seAudioContext.currentTime + duration);
            } catch (e) {
                // Èü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
            }
        }
        
        function playPunchSound() {
            // „Éë„É≥„ÉÅÈü≥ÔºöÁü≠„ÅÑÈ´òÈü≥
            playSound(200, 0.05, 'sawtooth', 0.2);
            playSound(300, 0.03, 'square', 0.15);
        }
        
        function playKickSound() {
            // „Ç≠„ÉÉ„ÇØÈü≥Ôºö‰Ωé„ÇÅ„ÅÆÈü≥
            playSound(150, 0.08, 'sawtooth', 0.25);
            playSound(200, 0.05, 'square', 0.2);
        }
        
        function playHitSound(isCritical = false) {
            // „Éí„ÉÉ„ÉàÈü≥
            if (isCritical) {
                playSound(400, 0.1, 'sine', 0.4);
                playSound(600, 0.08, 'sine', 0.3);
            } else {
                playSound(300, 0.06, 'sawtooth', 0.25);
                playSound(200, 0.04, 'square', 0.2);
            }
        }
        
        function playGuardSound() {
            // „Ç¨„Éº„ÉâÈü≥ÔºöÈáëÂ±ûÁöÑ„Å™Èü≥
            playSound(400, 0.1, 'sine', 0.3);
            playSound(600, 0.05, 'sine', 0.2);
        }
        
        function playGuardCrushSound() {
            // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•Èü≥ÔºöÁ†¥Ë£ÇÈü≥
            playSound(150, 0.2, 'sawtooth', 0.5);
            playSound(100, 0.15, 'sawtooth', 0.4);
        }
        
        function playSuperMoveSound(charType) {
            // Ë∂ÖÂøÖÊÆ∫ÊäÄÈü≥ÔºöËø´Âäõ„ÅÆ„ÅÇ„ÇãÈü≥
            playSound(100, 0.15, 'sawtooth', 0.5);
            playSound(200, 0.12, 'square', 0.4);
            playSound(400, 0.1, 'sine', 0.3);
            setTimeout(() => {
                playSound(300, 0.2, 'sawtooth', 0.4);
                playSound(500, 0.15, 'sine', 0.3);
            }, 100);
        }
        
        // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•„Ç∑„Çπ„ÉÜ„É†
        let screenFlash = { active: false, frames: 0, color: '#fff' };
        
        function createScreenFlash(color) {
            screenFlash.active = true;
            screenFlash.frames = 10;
            screenFlash.color = color;
        }
        
        function playSpecialSound(charType) {
            // ÂøÖÊÆ∫ÊäÄ„Åî„Å®„ÅÆÈü≥
            switch(charType) {
                case 'ash':
                    playSound(300, 0.15, 'sine', 0.4);
                    playSound(500, 0.12, 'sine', 0.3);
                    break;
                case 'cyberK':
                    playSound(400, 0.12, 'square', 0.35);
                    playSound(600, 0.1, 'sine', 0.25);
                    break;
                case 'granite':
                    playSound(100, 0.2, 'sawtooth', 0.5);
                    playSound(150, 0.18, 'sawtooth', 0.4);
                    break;
                case 'mystia':
                    playSound(350, 0.1, 'sine', 0.3);
                    playSound(450, 0.08, 'sine', 0.25);
                    break;
                case 'zen':
                    playSound(500, 0.08, 'sine', 0.3);
                    playSound(700, 0.06, 'sine', 0.2);
                    break;
                case 'universal':
                    playSound(300, 0.1, 'square', 0.3);
                    playSound(400, 0.08, 'sine', 0.25);
                    break;
            }
        }
        
        function playKOSound() {
            // KOÈü≥Ôºö‰Ωé„ÅÑÁ†¥Ë£ÇÈü≥
            playSound(80, 0.3, 'sawtooth', 0.6);
            playSound(120, 0.25, 'sawtooth', 0.5);
            setTimeout(() => {
                playSound(100, 0.2, 'sawtooth', 0.4);
            }, 200);
        }
        
        function playVictorySound() {
            // ÂãùÂà©Èü≥Ôºö‰∏äÊòá„Åô„ÇãÈü≥Èöé
            const notes = [262, 330, 392, 523]; // C, E, G, C
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    playSound(freq, 0.3, 'sine', 0.3);
                }, i * 150);
            });
        }
        
        let bgmPlaying = false;
        let bgmGainNode = null;
        let bgmIntervals = []; // BGMÁî®„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´„ÇíÁÆ°ÁêÜ
        
        function playBGM() {
            // „Éê„Éà„É´BGMÔºö‰Ωé„ÅÑ„Éì„Éº„Éà„Å®„É°„É≠„Éá„Ç£ÔºàBGMÁî®AudioContext„Çí‰ΩøÁî®Ôºâ
            if (bgmPlaying) return;
            
            try {
                if (!bgmAudioContext) {
                    initAudioContexts();
                }
                if (bgmAudioContext.state === 'suspended') {
                    bgmAudioContext.resume();
                }
                
                bgmPlaying = true;
                
                bgmGainNode = bgmAudioContext.createGain();
                bgmGainNode.gain.value = 0.15;
                bgmGainNode.connect(bgmAudioContext.destination);
                
                // „Éì„Éº„ÉàÁîüÊàê
                const beatInterval = setInterval(() => {
                    if (!bgmPlaying || !bgmAudioContext) {
                        clearInterval(beatInterval);
                        return;
                    }
                    try {
                        const beat = bgmAudioContext.createOscillator();
                        const beatGain = bgmAudioContext.createGain();
                        beat.connect(beatGain);
                        beatGain.connect(bgmGainNode);
                        beat.type = 'square';
                        beat.frequency.value = 60;
                        beatGain.gain.setValueAtTime(0.1, bgmAudioContext.currentTime);
                        beatGain.gain.exponentialRampToValueAtTime(0.01, bgmAudioContext.currentTime + 0.1);
                        beat.start();
                        beat.stop(bgmAudioContext.currentTime + 0.1);
                    } catch (e) {
                        // „Ç®„É©„ÉºÊôÇ„ÅØ„Ç§„É≥„Çø„Éº„Éê„É´„Çí„ÇØ„É™„Ç¢
                        clearInterval(beatInterval);
                    }
                }, 500);
                bgmIntervals.push(beatInterval);
                
                // „É°„É≠„Éá„Ç£Ôºà„É´„Éº„ÉóÔºâ
                let noteIndex = 0;
                const melodyNotes = [262, 294, 330, 349, 392, 440, 494, 523]; // C„É°„Ç∏„É£„Éº„Çπ„Ç±„Éº„É´
                const melodyInterval = setInterval(() => {
                    if (!bgmPlaying || !bgmAudioContext) {
                        clearInterval(melodyInterval);
                        return;
                    }
                    try {
                        const note = bgmAudioContext.createOscillator();
                        const noteGain = bgmAudioContext.createGain();
                        note.connect(noteGain);
                        noteGain.connect(bgmGainNode);
                        note.type = 'sine';
                        note.frequency.value = melodyNotes[noteIndex % melodyNotes.length];
                        noteGain.gain.setValueAtTime(0.05, bgmAudioContext.currentTime);
                        noteGain.gain.exponentialRampToValueAtTime(0.01, bgmAudioContext.currentTime + 0.5);
                        note.start();
                        note.stop(bgmAudioContext.currentTime + 0.5);
                        noteIndex++;
                    } catch (e) {
                        // „Ç®„É©„ÉºÊôÇ„ÅØ„Ç§„É≥„Çø„Éº„Éê„É´„Çí„ÇØ„É™„Ç¢
                        clearInterval(melodyInterval);
                    }
                }, 600);
                bgmIntervals.push(melodyInterval);
            } catch (e) {
                console.warn('BGMÂÜçÁîü„Ç®„É©„Éº:', e);
                bgmPlaying = false;
            }
        }
        
        function stopBGM() {
            bgmPlaying = false;
            
            // „Åô„Åπ„Å¶„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´„Çí„ÇØ„É™„Ç¢
            bgmIntervals.forEach(interval => clearInterval(interval));
            bgmIntervals = [];
            
            if (bgmGainNode && bgmAudioContext) {
                try {
                    bgmGainNode.gain.exponentialRampToValueAtTime(0.01, bgmAudioContext.currentTime + 0.5);
                    setTimeout(() => {
                        if (bgmGainNode) {
                            bgmGainNode.disconnect();
                            bgmGainNode = null;
                        }
                    }, 500);
                } catch (e) {
                    bgmGainNode = null;
                }
            }
        }
        
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 8;
                this.vy = (Math.random() - 0.5) * 8 - 2;
                this.life = 30;
                this.maxLife = 30;
                this.color = color;
                this.size = Math.random() * 4 + 2;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.3;
                this.life--;
            }
            
            draw() {
                ctx.save();
                ctx.globalAlpha = this.life / this.maxLife;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
                ctx.restore();
            }
        }
        
        class DamageNumber {
            constructor(x, y, damage, isCritical, comboCount) {
                this.x = x;
                this.y = y;
                this.damage = Math.round(damage);
                this.isCritical = isCritical;
                this.comboCount = comboCount || 1;
                this.vx = (Math.random() - 0.5) * 3;
                this.vy = -5 - Math.random() * 3;
                this.life = 60;
                this.maxLife = 60;
                this.scale = isCritical ? 1.5 : 1.0;
                this.rotation = (Math.random() - 0.5) * 0.3;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.2;
                this.life--;
                if (this.life < 20) {
                    this.scale *= 0.95; // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÊôÇ„Å´Á∏ÆÂ∞è
                }
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.scale(this.scale, this.scale);
                
                const alpha = this.life / this.maxLife;
                ctx.globalAlpha = alpha;
                
                // „Ç≥„É≥„ÉúÊï∞„Å´Âøú„Åò„ÅüËâ≤
                let color = '#fff';
                if (this.isCritical) {
                    color = '#ff0';
                } else if (this.comboCount >= 5) {
                    color = '#f0f';
                } else if (this.comboCount >= 3) {
                    color = '#f88';
                }
                
                // Êï∞Â≠ó„ÇíÊèèÁîª
                ctx.fillStyle = color;
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 4;
                ctx.font = `bold ${30 + this.comboCount * 2}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(`-${this.damage}`, 0, 0);
                ctx.fillText(`-${this.damage}`, 0, 0);
                
                // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´ÊôÇ„ÅØ„Äå!„Äç„ÇÇË°®Á§∫
                if (this.isCritical) {
                    ctx.font = 'bold 40px Arial';
                    ctx.strokeText('!', 35, -10);
                    ctx.fillText('!', 35, -10);
                }
                
                ctx.restore();
            }
        }
        
        class CriticalText {
            constructor(x, y, text) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.life = 90;
                this.maxLife = 90;
                this.vy = -2;
                this.scale = 0;
                this.targetScale = 1.5;
            }
            
            update() {
                this.y += this.vy;
                this.life--;
                
                // „Çπ„Ç±„Éº„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                if (this.life > 60) {
                    this.scale = (this.maxLife - this.life) / 30 * this.targetScale;
                } else if (this.life < 20) {
                    this.scale = (this.life / 20) * this.targetScale;
                } else {
                    this.scale = this.targetScale;
                }
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.scale(this.scale, this.scale);
                
                const alpha = this.life / this.maxLife;
                ctx.globalAlpha = alpha;
                
                ctx.fillStyle = '#ff0';
                ctx.strokeStyle = '#f00';
                ctx.lineWidth = 6;
                ctx.font = 'bold 50px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(this.text, 0, 0);
                ctx.fillText(this.text, 0, 0);
                
                // ÂÖâ„Çã„Ç®„Éï„Çß„ÇØ„Éà
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#ff0';
                ctx.fillText(this.text, 0, 0);
                
                ctx.restore();
            }
        }
        
        function shakeCamera(intensity, frames) {
            cameraShake.frames = frames;
            cameraShake.intensity = intensity;
        }
        
        function startSlowMotion(speed, frames) {
            slowMotionActive = true;
            slowMotionFrames = frames;
            slowMotionSpeed = speed;
        }
        
        class Player {
            constructor(x, y, controls, charType, facing, isCPU = false) {
                this.x = x;
                this.y = y;
                this.width = 30;
                this.height = 80;
                this.vx = 0;
                this.vy = 0;
                this.controls = controls;
                this.facing = facing;
                this.onGround = false;
                this.isCPU = isCPU;
                
                // CPUÁî®„ÅÆÂ§âÊï∞
                if (isCPU) {
                    this.aiReactionTime = 0;
                    this.aiActionCooldown = 0;
                    this.aiState = 'idle'; // 'idle', 'approach', 'attack', 'defend', 'retreat'
                    this.aiTargetDistance = 0;
                }
                
                // „Ç≠„É£„É©„ÇØ„Çø„ÉºÁâπÊÄß
                const charData = characterData[charType];
                this.name = charData.name;
                this.color = charData.color;
                this.speed = charData.speed;
                this.jumpPower = charData.jumpPower;
                this.attacks = charData.attacks;
                this.charType = charType; // „Ç≠„É£„É©„ÇØ„Çø„Éº„Çø„Ç§„Éó„Çí‰øùÂ≠ò
                
                // „Ç≤„Éº„É†Áä∂ÊÖã
                this.health = 100;
                this.maxHealth = 100;
                this.isAttacking = false;
                this.attackType = null;
                this.attackFrame = 0;
                this.isBlocking = false;
                this.stunned = 0;
                this.invincible = 0;
                
                // „Ç≥„É≥„Éú„Ç∑„Çπ„ÉÜ„É†
                this.comboCount = 0;
                this.comboTimer = 0;
                this.comboWindow = 60; // „Éï„É¨„Éº„É†Êï∞ÔºàÁ¥Ñ1ÁßíÔºâ
                
                // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•„Ç∑„Çπ„ÉÜ„É†
                this.guardGauge = 100;
                this.maxGuardGauge = 100;
                this.guardCrushed = false;
                this.guardCrushedTime = 0;
                
                // Ë∂ÖÂøÖÊÆ∫ÊäÄÔºà„Çπ„Éº„Éë„Éº„Ç≥„É≥„ÉúÔºâ„Ç∑„Çπ„ÉÜ„É†
                this.superGauge = 0; // ÁèæÂú®„ÅÆ„Ç≤„Éº„Ç∏Ôºà0-300„ÄÅ1„Ç≤„Éº„Ç∏=100Ôºâ
                this.maxSuperGauge = 300; // ÊúÄÂ§ß3„Ç≤„Éº„Ç∏
                this.superGaugeGainOnHit = 15; // ÊîªÊíÉÂëΩ‰∏≠ÊôÇ„ÅÆ„Ç≤„Éº„Ç∏Â¢óÂä†Èáè
                this.superGaugeGainOnBlock = 8; // „Ç¨„Éº„ÉâÊôÇ„ÅÆ„Ç≤„Éº„Ç∏Â¢óÂä†Èáè
                this.superGaugeGainOnDamage = 20; // Ë¢´ÂºæÊôÇ„ÅÆ„Ç≤„Éº„Ç∏Â¢óÂä†Èáè
                this.superMoveActive = false; // Ë∂ÖÂøÖÊÆ∫ÊäÄÁô∫Âãï‰∏≠„Åã
                this.superMoveFrame = 0; // Ë∂ÖÂøÖÊÆ∫ÊäÄ„ÅÆ„Éï„É¨„Éº„É†
                this.superMoveName = null; // Ë∂ÖÂøÖÊÆ∫ÊäÄÂêç
                
                // „Éí„ÉÉ„Éà„Çπ„Éà„ÉÉ„Éó
                this.hitStopFrames = 0;
                this.hitStopActive = false;
                
                // ÁâπÊÆäËÉΩÂäõ„Ç∑„Çπ„ÉÜ„É†
                this.specialAbilityActive = false;
                this.specialAbilityType = null;
                this.specialAbilityFrame = 0;
                this.counterReady = false; // Zen„ÅÆ„Ç´„Ç¶„É≥„Çø„ÉºÂæÖÊ©üÁä∂ÊÖã
                this.evadeFrames = 0; // Universal„ÅÆÂõûÈÅø„Éï„É¨„Éº„É†
                
                // „Ç≥„Éû„É≥„ÉâÂÖ•Âäõ„Ç∑„Çπ„ÉÜ„É†
                this.inputHistory = []; // ÂÖ•ÂäõÂ±•Ê≠¥
                this.inputBufferTime = 20; // ÂÖ•Âäõ„Éê„ÉÉ„Éï„Ç°ÊôÇÈñìÔºà„Éï„É¨„Éº„É†Ôºâ
                this.specialMoveName = null; // Áô∫Âãï„Åó„ÅüÂøÖÊÆ∫ÊäÄÂêç
                this.specialMoveNameFrames = 0; // ÂøÖÊÆ∫ÊäÄÂêçË°®Á§∫ÊôÇÈñì
                
                // „Ç≠„É£„É≥„Çª„É´„Ç∑„Çπ„ÉÜ„É†
                this.lastHitConnected = false; // ÊúÄÂæå„ÅÆÊîªÊíÉ„Åå„Éí„ÉÉ„Éà„Åó„Åü„Åã
                this.guardCrushComboReady = false; // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•Âæå„ÅÆÁ¢∫ÂÆö„Ç≥„É≥„ÉúÂèØËÉΩÁä∂ÊÖã
                this.jumpAttackHit = false; // „Ç∏„É£„É≥„ÉóÊîªÊíÉ„Åå„Éí„ÉÉ„Éà„Åó„Åü„Åã
                this.airComboReady = false; // Á©∫‰∏≠„Ç≥„É≥„ÉúÂèØËÉΩÁä∂ÊÖã
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                this.animFrame = 0;
                this.animSpeed = 0.2;
            }
            
            update() {
                // „Éí„ÉÉ„Éà„Çπ„Éà„ÉÉ„Éó‰∏≠„ÅØÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó
                if (this.hitStopActive && this.hitStopFrames > 0) {
                    this.hitStopFrames--;
                    if (this.hitStopFrames <= 0) {
                        this.hitStopActive = false;
                    }
                    return;
                }
                
                // CPU„ÅÆÂ†¥Âêà„ÅØAI„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂÆüË°å
                if (this.isCPU) {
                    this.updateCPU();
                }
                
                // „Çπ„Çø„É≥/ÁÑ°ÊïµÊôÇÈñì
                if (this.stunned > 0) {
                    this.stunned--;
                    if (this.isCPU) {
                        this.aiReactionTime = 10; // „Çπ„Çø„É≥‰∏≠„ÅØAIÂèçÂøúÊôÇÈñì„Çí„É™„Çª„ÉÉ„Éà
                    }
                    return;
                }
                if (this.invincible > 0) this.invincible--;
                
                // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•Áä∂ÊÖã„ÅÆÊõ¥Êñ∞
                if (this.guardCrushed) {
                    this.guardCrushedTime--;
                    if (this.guardCrushedTime <= 0) {
                        this.guardCrushed = false;
                        this.guardGauge = this.maxGuardGauge; // „Ç¨„Éº„Éâ„Ç≤„Éº„Ç∏ÂõûÂæ©
                    }
                }
                
                // „Ç≥„É≥„Éú„Çø„Ç§„Éû„Éº„ÅÆÊõ¥Êñ∞
                if (this.comboTimer > 0) {
                    this.comboTimer--;
                    if (this.comboTimer <= 0) {
                        this.comboCount = 0; // „Ç≥„É≥„Éú„É™„Çª„ÉÉ„Éà
                    }
                }
                
                // Ë∂ÖÂøÖÊÆ∫ÊäÄ‰∏≠„ÅÆÂá¶ÁêÜ
                if (this.superMoveActive) {
                    this.superMoveFrame++;
                    this.attackFrame++;
                    const charData = characterData[this.charType];
                    const superMove = charData.superMove;
                    
                    if (this.attackFrame === superMove.startup) {
                        this.performSuperMove();
                    }
                    
                    if (this.attackFrame >= superMove.startup + superMove.recovery) {
                        this.superMoveActive = false;
                        this.superMoveFrame = 0;
                        this.isAttacking = false;
                        this.attackFrame = 0;
                        this.attackType = null;
                    }
                    
                    // Ë∂ÖÂøÖÊÆ∫ÊäÄ‰∏≠„ÇÇÈáçÂäõÈÅ©Áî®
                    this.vy += 0.8;
                    this.x += this.vx;
                    this.y += this.vy;
                    
                    const groundY = canvas.height - 100;
                    if (this.y + this.height >= groundY) {
                        this.y = groundY - this.height;
                        this.vy = 0;
                        this.onGround = true;
                    }
                    
                    this.updateInputHistory();
                    this.animFrame += this.animSpeed;
                    return;
                }
                
                // ÊîªÊíÉ‰∏≠„ÅÆÂá¶ÁêÜ
                if (this.isAttacking) {
                    this.attackFrame++;
                    const attack = this.attacks[this.attackType];
                    
                    if (this.attackFrame === attack.startup) {
                        const hitResult = this.performAttack();
                        // „Éí„ÉÉ„Éà„Åó„ÅüÂ†¥Âêà„ÅØ„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Éï„É©„Ç∞„ÇíË®≠ÂÆö
                        if (hitResult && hitResult.hit) {
                            this.lastHitConnected = true;
                        }
                    }
                    
                    // „Ç≠„É£„É≥„Çª„É´Âà§ÂÆöÔºà„Éí„ÉÉ„ÉàÊôÇ„ÅÆ„ÅøÂèØËÉΩ„ÄÅ„Éí„ÉÉ„Éà„Éï„É¨„Éº„É†‰ª•ÈôçÔºâ
                    if (this.attackFrame > attack.startup && this.canCancelAttack(attack) && !this.isCPU) {
                        const cancelType = this.checkCancelInput();
                        if (cancelType) {
                            // „Ç≠„É£„É≥„Çª„É´ÂÆüË°å
                            this.isAttacking = false;
                            this.attackFrame = 0;
                            this.lastHitConnected = false;
                            this.startAttack(cancelType);
                            return; // Êñ∞„Åó„ÅÑÊîªÊíÉ„ÇíÈñãÂßã
                        }
                    }
                    
                    if (this.attackFrame >= attack.startup + attack.recovery) {
                        this.isAttacking = false;
                        this.attackFrame = 0;
                        this.lastHitConnected = false; // „É™„Çª„ÉÉ„Éà
                    }
                    
                    // ÊîªÊíÉ‰∏≠„Åß„ÇÇÈáçÂäõ„Å®‰ΩçÁΩÆÊõ¥Êñ∞„ÅØÈÅ©Áî®Ôºà„Ç∏„É£„É≥„Éó‰∏≠„Åß„ÇÇËêΩ‰∏ã„Åô„ÇãÔºâ
                    // „Åü„Å†„ÅóÁßªÂãïÂÖ•Âäõ„ÅØÂà∂ÈôêÔºàËªΩ„Åè„Å†„ÅëÂà∂ÈôêÔºâ
                    if (this.onGround) {
                        this.vx = 0; // Âú∞‰∏ä„Åß„ÅØÁßªÂãï‰∏çÂèØ
                    } else {
                        // Á©∫‰∏≠„Åß„ÅØÂ∞ë„Åó„Å†„ÅëÁßªÂãïÂèØËÉΩ
                        this.vx *= 0.9; // Ê∏õÈÄü
                    }
                    
                    // ÈáçÂäõÈÅ©Áî®
                    this.vy += 0.8;
                    
                    // ‰ΩçÁΩÆÊõ¥Êñ∞
                    this.x += this.vx;
                    this.y += this.vy;
                    
                    // Âú∞Èù¢Âà§ÂÆö
                    const groundY = canvas.height - 100;
                    if (this.y + this.height >= groundY) {
                        this.y = groundY - this.height;
                        this.vy = 0;
                        const wasInAir = !this.onGround;
                        this.onGround = true;
                        
                        // „Ç∏„É£„É≥„ÉóÊîªÊíÉ„Åã„Çâ„ÅÆËøΩÊíÉ„Ç≥„É≥„ÉúÔºàÁùÄÂú∞Áõ¥ÂæåÔºâ
                        if (wasInAir && this.airComboReady && !this.isAttacking) {
                            // „Ç≥„É≥„Éú„Ç¶„Ç£„É≥„Éâ„Ç¶Âª∂Èï∑ÔºàÁùÄÂú∞Âæå„Å´„Åô„ÅêÊîªÊíÉ„Åô„Çå„Å∞„Ç≥„É≥„ÉúÁ∂ôÁ∂öÔºâ
                            this.comboTimer = this.comboWindow;
                        } else if (this.onGround && !this.airComboReady) {
                            // Âú∞Èù¢„Å´ÁùÄÂú∞„Åó„Åü„ÇâÁ©∫‰∏≠„Ç≥„É≥„Éú„Éï„É©„Ç∞„É™„Çª„ÉÉ„Éà
                            this.jumpAttackHit = false;
                        }
                    }
                    
                    // ÁîªÈù¢Á´Ø
                    if (this.x < 0) this.x = 0;
                    if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
                    
                    // ÂÖ•ÂäõÂ±•Ê≠¥„ÅÆÁÆ°ÁêÜ„Å®„Ç≥„Éû„É≥„ÉâÂà§ÂÆö„ÅØÁ∂öË°åÔºàÊ¨°„ÅÆÊîªÊíÉÊ∫ñÂÇôÔºâ
                    this.updateInputHistory();
                    this.animFrame += this.animSpeed;
                    return;
                }
                
                // ÁßªÂãï
                this.vx = 0;
                this.isBlocking = false;
                
                if (keys[this.controls.left]) {
                    this.vx = -this.speed;
                    this.facing = -1;
                }
                if (keys[this.controls.right]) {
                    this.vx = this.speed;
                    this.facing = 1;
                }
                if (keys[this.controls.down]) {
                    this.isBlocking = true;
                }
                if (keys[this.controls.up] && this.onGround) {
                    this.vy = -this.jumpPower;
                    this.onGround = false;
                }
                
                // ÁâπÊÆäËÉΩÂäõÂá¶ÁêÜ
                if (this.specialAbilityActive) {
                    this.updateSpecialAbility();
                    
                    // ÁâπÊÆäËÉΩÂäõ‰∏≠„ÇÇÈáçÂäõÈÅ©Áî®
                    this.vy += 0.8;
                    this.x += this.vx;
                    this.y += this.vy;
                    
                    // Âú∞Èù¢Âà§ÂÆö
                    const groundY = canvas.height - 100;
                    if (this.y + this.height >= groundY) {
                        this.y = groundY - this.height;
                        this.vy = 0;
                        const wasInAir = !this.onGround;
                        this.onGround = true;
                        
                        // „Ç∏„É£„É≥„ÉóÊîªÊíÉ„Åã„Çâ„ÅÆËøΩÊíÉ„Ç≥„É≥„ÉúÔºàÁùÄÂú∞Áõ¥ÂæåÔºâ
                        if (wasInAir && this.airComboReady && !this.isAttacking && !this.isCPU) {
                            // „Ç≥„É≥„Éú„Ç¶„Ç£„É≥„Éâ„Ç¶Âª∂Èï∑ÔºàÁùÄÂú∞Âæå„Å´„Åô„ÅêÊîªÊíÉ„Åô„Çå„Å∞„Ç≥„É≥„ÉúÁ∂ôÁ∂öÔºâ
                            this.comboTimer = this.comboWindow;
                        } else if (this.onGround && !this.airComboReady) {
                            // Âú∞Èù¢„Å´ÁùÄÂú∞„Åó„Åü„ÇâÁ©∫‰∏≠„Ç≥„É≥„Éú„Éï„É©„Ç∞„É™„Çª„ÉÉ„Éà
                            this.jumpAttackHit = false;
                        }
                    }
                    
                    // ÁîªÈù¢Á´Ø
                    if (this.x < 0) this.x = 0;
                    if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
                    
                    this.updateInputHistory();
                    this.animFrame += this.animSpeed;
                    return;
                }
                
                // ÊîªÊíÉ
                if (keys[this.controls.punch] && !this.isAttacking) {
                    // Granite„ÅÆÊäï„ÅíÊäÄ: ËøëË∑ùÈõ¢„Åß‰∏ã+„Éë„É≥„ÉÅÂêåÊôÇÊäº„Åó
                    if (this.charType === 'granite' && keys[this.controls.down] && this.onGround) {
                        const opponent = this === player1 ? player2 : player1;
                        const distance = Math.abs(this.x - opponent.x);
                        if (distance < 50 && !opponent.isAttacking && opponent.stunned === 0) {
                            this.startSpecialAbility('throw');
                            return;
                        }
                    }
                    
                    // „Ç∏„É£„É≥„ÉóÊîªÊíÉ„Åã„Çâ„ÅÆËøΩÊíÉ„Ç≥„É≥„ÉúÂà§ÂÆö
                    if (this.airComboReady && this.onGround && this.comboTimer > 0) {
                        // „Ç≥„É≥„ÉúÁ∂ôÁ∂ö
                        this.airComboReady = false;
                    }
                    
                    playPunchSound();
                    this.startAttack('punch');
                }
                if (keys[this.controls.kick] && !this.isAttacking) {
                    // „Ç∏„É£„É≥„ÉóÊîªÊíÉ„Åã„Çâ„ÅÆËøΩÊíÉ„Ç≥„É≥„ÉúÂà§ÂÆö
                    if (this.airComboReady && this.onGround && this.comboTimer > 0) {
                        // „Ç≥„É≥„ÉúÁ∂ôÁ∂ö
                        this.airComboReady = false;
                    }
                    
                    playKickSound();
                    this.startAttack('kick');
                }
                if (keys[this.controls.special] && !this.isAttacking) {
                    // Universal„ÅÆÁ∑äÊÄ•ÂõûÈÅø: ÁâπÊÆä„Ç≠„Éº+Âæå„ÇçÊñπÂêë
                    if (this.charType === 'universal') {
                        const backKey = this.facing === 1 ? this.controls.left : this.controls.right;
                        if (keys[backKey]) {
                            this.startSpecialAbility('evade');
                            return;
                        }
                    }
                    // „Ç≥„Éû„É≥„ÉâÂÖ•Âäõ„Åß„ÅÆÂøÖÊÆ∫ÊäÄÁô∫Âãï„ÅØupdateInputHistoryÂÜÖ„ÅßÂá¶ÁêÜ„Åï„Çå„Çã
                    // ÂçòÁ¥î„Å™special„Ç≠„ÉºÊäº‰∏ã„Åß„ÅÆÂøÖÊÆ∫ÊäÄ„ÅØÂªÉÊ≠¢Ôºà„Ç≥„Éû„É≥„ÉâÂøÖÈ†àÔºâ
                }
                
                // Mystia„ÅÆÊä±ÊìÅÊäÄ: ËøëË∑ùÈõ¢„Åß‰∏ä+„Ç≠„ÉÉ„ÇØÂêåÊôÇÊäº„Åó
                if (this.charType === 'mystia' && keys[this.controls.kick] && keys[this.controls.up] && !this.isAttacking && this.onGround) {
                    const opponent = this === player1 ? player2 : player1;
                    const distance = Math.abs(this.x - opponent.x);
                    if (distance < 60 && !opponent.isAttacking && opponent.stunned === 0) {
                        this.startSpecialAbility('hug');
                        return;
                    }
                }
                
                // ÈáçÂäõ
                this.vy += 0.8;
                
                // ‰ΩçÁΩÆÊõ¥Êñ∞
                this.x += this.vx;
                this.y += this.vy;
                
                // Âú∞Èù¢Âà§ÂÆö
                const groundY = canvas.height - 100;
                if (this.y + this.height >= groundY) {
                    this.y = groundY - this.height;
                    this.vy = 0;
                    const wasInAir = !this.onGround;
                    this.onGround = true;
                    
                    // „Ç∏„É£„É≥„ÉóÊîªÊíÉ„Åã„Çâ„ÅÆËøΩÊíÉ„Ç≥„É≥„ÉúÔºàÁùÄÂú∞Áõ¥ÂæåÔºâ
                    if (wasInAir && this.airComboReady && !this.isAttacking && !this.isCPU) {
                        // „Ç≥„É≥„Éú„Ç¶„Ç£„É≥„Éâ„Ç¶Âª∂Èï∑ÔºàÁùÄÂú∞Âæå„Å´„Åô„ÅêÊîªÊíÉ„Åô„Çå„Å∞„Ç≥„É≥„ÉúÁ∂ôÁ∂öÔºâ
                        this.comboTimer = this.comboWindow;
                    } else if (this.onGround && !this.airComboReady) {
                        // Âú∞Èù¢„Å´ÁùÄÂú∞„Åó„Åü„ÇâÁ©∫‰∏≠„Ç≥„É≥„Éú„Éï„É©„Ç∞„É™„Çª„ÉÉ„Éà
                        this.jumpAttackHit = false;
                    }
                }
                
                // ÁîªÈù¢Á´Ø
                if (this.x < 0) this.x = 0;
                if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
                
                // ÂÖ•ÂäõÂ±•Ê≠¥„ÅÆÁÆ°ÁêÜ
                this.updateInputHistory();
                
                // „Ç≥„Éû„É≥„ÉâÂà§ÂÆöÔºàÊîªÊíÉ‰∏≠„Åß„Å™„ÅÑÊôÇ„ÅÆ„ÅøÔºâ
                if (!this.isAttacking && !this.specialAbilityActive && !this.superMoveActive) {
                    // Ë∂ÖÂøÖÊÆ∫ÊäÄ„Ç≥„Éû„É≥„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
                    if (this.checkSuperMoveCommand()) {
                        this.executeSuperMove();
                    } else {
                        // ÈÄöÂ∏∏ÂøÖÊÆ∫ÊäÄ„Ç≥„Éû„É≥„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
                        const command = this.checkCommand();
                        if (command) {
                            this.executeSpecialMove(command);
                        }
                    }
                }
                
                // ÂøÖÊÆ∫ÊäÄÂêçË°®Á§∫ÊôÇÈñì„ÅÆÊõ¥Êñ∞
                if (this.specialMoveNameFrames > 0) {
                    this.specialMoveNameFrames--;
                }
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                this.animFrame += this.animSpeed;
            }
            
            updateInputHistory() {
                // ÁèæÂú®„ÅÆÂÖ•ÂäõÁä∂ÊÖã„ÇíË®òÈå≤
                const currentInput = {
                    left: keys[this.controls.left] || false,
                    right: keys[this.controls.right] || false,
                    up: keys[this.controls.up] || false,
                    down: keys[this.controls.down] || false,
                    punch: keys[this.controls.punch] || false,
                    kick: keys[this.controls.kick] || false,
                    special: keys[this.controls.special] || false
                };
                
                // ÂÖ•ÂäõÂ±•Ê≠¥„Å´ËøΩÂä†ÔºàÊúÄÂ§ß20„Éï„É¨„Éº„É†ÂàÜÔºâ
                this.inputHistory.push({ input: currentInput, frame: 0 });
                if (this.inputHistory.length > this.inputBufferTime) {
                    this.inputHistory.shift();
                }
                
                // „Éï„É¨„Éº„É†Êï∞„ÇíÊõ¥Êñ∞
                this.inputHistory.forEach(item => item.frame++);
                
                // Âè§„ÅÑÂÖ•ÂäõÂ±•Ê≠¥„ÇíÂâäÈô§
                this.inputHistory = this.inputHistory.filter(item => item.frame < this.inputBufferTime);
            }
            
            checkCommand() {
                // ÂêÑ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂøÖÊÆ∫ÊäÄ„Ç≥„Éû„É≥„ÉâÂÆöÁæ©
                const commands = this.getSpecialMoveCommands();
                
                // ÂÖ•ÂäõÂ±•Ê≠¥„Åã„Çâ„Ç≥„Éû„É≥„Éâ„ÇíÂà§ÂÆö
                for (const cmd of commands) {
                    if (this.matchCommand(cmd.sequence, cmd.button)) {
                        return cmd.name;
                    }
                }
                
                return null;
            }
            
            getSpecialMoveCommands() {
                // „Ç≠„É£„É©„ÇØ„Çø„Éº„Åî„Å®„ÅÆÂøÖÊÆ∫ÊäÄ„Ç≥„Éû„É≥„ÉâÂÆöÁæ©
                const facing = this.facing;
                const forward = facing === 1 ? 'right' : 'left';
                const back = facing === 1 ? 'left' : 'right';
                
                switch(this.charType) {
                    case 'ash':
                        return [
                            { sequence: ['down', forward, 'punch'], name: 'ultimate_impact' },
                            { sequence: [forward, 'down', forward, 'punch'], name: 'ultimate_impact' }
                        ];
                    case 'cyberK':
                        return [
                            { sequence: ['down', forward, 'kick'], name: 'middle_kick' },
                            { sequence: [forward, 'down', forward, 'kick'], name: 'middle_kick' }
                        ];
                    case 'granite':
                        return [
                            { sequence: ['down', 'down', forward, 'punch'], name: 'granite_press' },
                            { sequence: [forward, 'down', 'down', forward, 'punch'], name: 'granite_press' }
                        ];
                    case 'mystia':
                        return [
                            { sequence: ['down', forward, 'kick'], name: 'mujihi_hoyo' },
                            { sequence: ['up', forward, 'kick'], name: 'mujihi_hoyo' }
                        ];
                    case 'zen':
                        return [
                            { sequence: ['down', back, 'punch'], name: 'kuusemi_gaashi' },
                            { sequence: [back, 'down', back, 'punch'], name: 'kuusemi_gaashi' }
                        ];
                    case 'universal':
                        return [
                            { sequence: ['down', forward, 'special'], name: 'emergency_step' },
                            { sequence: [forward, back, forward, 'special'], name: 'emergency_step' }
                        ];
                    default:
                        return [];
                }
            }
            
            checkSuperMoveCommand() {
                // „Ç≤„Éº„Ç∏„ÅåË∂≥„Çä„Å™„ÅÑÂ†¥Âêà„ÅØÁô∫Âãï‰∏çÂèØ
                const charData = characterData[this.charType];
                if (!charData.superMove) return false;
                if (this.superGauge < charData.superMove.gaugeCost) return false;
                
                // Ë∂ÖÂøÖÊÆ∫ÊäÄ„Ç≥„Éû„É≥„ÉâÂà§ÂÆö
                const command = charData.superMove.command;
                const facing = this.facing;
                const forward = facing === 1 ? 'right' : 'left';
                const back = facing === 1 ? 'left' : 'right';
                
                // „Ç≥„Éû„É≥„Éâ„ÇíÂêë„Åç„Å´Âøú„Åò„Å¶Â§âÊèõ
                const normalizedCommand = command.map(cmd => {
                    if (cmd === 'forward') return forward;
                    if (cmd === 'back') return back;
                    return cmd;
                });
                
                // „Éú„Çø„É≥„ÅØÊúÄÂæå„ÅÆË¶ÅÁ¥†
                const button = normalizedCommand[normalizedCommand.length - 1];
                const sequence = normalizedCommand.slice(0, -1);
                
                if (this.matchCommand(sequence, button)) {
                    return true;
                }
                
                return false;
            }
            
            matchCommand(sequence, button) {
                // ÂÖ•ÂäõÂ±•Ê≠¥„Åã„Çâ„Ç≥„Éû„É≥„Éâ„Ç∑„Éº„Ç±„É≥„Çπ„Çí„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                if (this.inputHistory.length < sequence.length) return false;
                
                // „Éú„Çø„É≥„ÅåÊäº„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÊúÄÊñ∞„ÅÆÊï∞„Éï„É¨„Éº„É†ÂÜÖÔºâ
                const recentFrames = 5;
                let buttonPressed = false;
                for (let i = 0; i < recentFrames && i < this.inputHistory.length; i++) {
                    const input = this.inputHistory[this.inputHistory.length - 1 - i].input;
                    if (button === 'punch' && input.punch) buttonPressed = true;
                    if (button === 'kick' && input.kick) buttonPressed = true;
                    if (button === 'special' && input.special) buttonPressed = true;
                }
                if (!buttonPressed) return false;
                
                // „Ç∑„Éº„Ç±„É≥„Çπ„ÇíÈÄÜÈ†Ü„Åß„ÉÅ„Çß„ÉÉ„ÇØÔºàÊúÄÊñ∞„ÅÆÂÖ•Âäõ„Åã„ÇâÔºâ
                let seqIndex = sequence.length - 1;
                let lastFoundFrame = -1;
                const forward = this.facing === 1 ? 'right' : 'left';
                const back = this.facing === 1 ? 'left' : 'right';
                
                for (let i = this.inputHistory.length - 1; i >= 0 && seqIndex >= 0; i--) {
                    const item = this.inputHistory[i];
                    const input = item.input;
                    
                    // „Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÊôÇÁÇπ„ÅÆÂÖ•Âäõ„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                    if (item.frame === 0) {
                        if ((button === 'punch' && input.punch) || 
                            (button === 'kick' && input.kick) || 
                            (button === 'special' && input.special)) {
                            continue;
                        }
                    }
                    
                    // ÊñπÂêëÂÖ•Âäõ„ÅÆÂà§ÂÆö
                    let direction = null;
                    // ÂçòÁ¥î„Å™ÊñπÂêëÂÖ•Âäõ
                    if (input.left && !input.right && !input.up && !input.down) direction = 'left';
                    if (input.right && !input.left && !input.up && !input.down) direction = 'right';
                    if (input.up && !input.down && !input.left && !input.right) direction = 'up';
                    if (input.down && !input.up && !input.left && !input.right) direction = 'down';
                    
                    // forward/back„ÇíÂÆüÈöõ„ÅÆÂêë„Åç„Å´Â§âÊèõ
                    let actualDirection = direction;
                    if (direction === 'left') actualDirection = back;
                    if (direction === 'right') actualDirection = forward;
                    
                    if (actualDirection === sequence[seqIndex] || direction === sequence[seqIndex]) {
                        if (lastFoundFrame === -1 || item.frame < lastFoundFrame) {
                            lastFoundFrame = item.frame;
                            seqIndex--;
                        }
                    }
                }
                
                return seqIndex < 0; // „Åô„Åπ„Å¶„ÅÆ„Ç∑„Éº„Ç±„É≥„Çπ„ÅåË¶ã„Å§„Åã„Å£„Åü
            }
            
            executeSpecialMove(moveName) {
                // ÂøÖÊÆ∫ÊäÄ„ÇíÁô∫Âãï
                this.specialMoveName = moveName;
                this.specialMoveNameFrames = 60; // 1ÁßíÈñìË°®Á§∫
                this.startAttack('special');
                this.inputHistory = []; // ÂÖ•ÂäõÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢
                playSpecialSound(this.charType);
            }
            
            executeSuperMove() {
                // Ë∂ÖÂøÖÊÆ∫ÊäÄ„ÇíÁô∫Âãï
                const charData = characterData[this.charType];
                if (!charData.superMove) return;
                
                // „Ç≤„Éº„Ç∏Ê∂àË≤ª
                this.superGauge -= charData.superMove.gaugeCost;
                
                // Ë∂ÖÂøÖÊÆ∫ÊäÄÁô∫Âãï
                this.superMoveActive = true;
                this.superMoveFrame = 0;
                this.superMoveName = charData.superMove.name;
                this.isAttacking = true;
                this.attackType = 'super';
                this.attackFrame = 0;
                this.vx = 0; // ÁßªÂãïÂÅúÊ≠¢
                
                // ÂÖ•ÂäõÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢
                this.inputHistory = [];
                
                // ÊºîÂá∫ÈñãÂßã
                playSuperMoveSound(this.charType);
                shakeCamera(15, 30);
                startSlowMotion(0.3, 40);
                
                // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•
                createScreenFlash(this.color);
            }
            
            updateCPU() {
                const opponent = this === player1 ? player2 : player1;
                const distance = Math.abs(this.x - opponent.x);
                const heightDiff = Math.abs(this.y - opponent.y);
                
                // AIÂèçÂøúÊôÇÈñì„Å®„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥„ÅÆÊõ¥Êñ∞
                if (this.aiReactionTime > 0) {
                    this.aiReactionTime--;
                }
                
                if (this.aiActionCooldown > 0) {
                    this.aiActionCooldown--;
                }
                
                // Áõ∏Êâã„ÅÆÂêë„Åç„ÇíÁ¢∫Ë™çÔºàCPU„ÅØÂ∏∏„Å´Áõ∏Êâã„ÅÆÊñπ„ÇíÂêë„ÅèÔºâ
                if (opponent.x < this.x) {
                    this.facing = -1;
                } else {
                    this.facing = 1;
                }
                
                // CPU„ÅÆ„Ç≠„ÉºÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„ÉàÔºàÊØé„Éï„É¨„Éº„É†Ôºâ
                keys[this.controls.left] = false;
                keys[this.controls.right] = false;
                keys[this.controls.up] = false;
                keys[this.controls.down] = false;
                keys[this.controls.punch] = false;
                keys[this.controls.kick] = false;
                
                // ÂèçÂøúÊôÇÈñì‰∏≠„ÇÑ„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥‰∏≠„ÅØË°åÂãï„Åó„Å™„ÅÑ
                if (this.aiReactionTime > 0 || this.aiActionCooldown > 0) {
                    return;
                }
                
                // „Çπ„Çø„É≥‰∏≠„ÇÑÊîªÊíÉ‰∏≠„ÅØË°åÂãï„Åó„Å™„ÅÑ
                if (this.stunned > 0 || this.isAttacking || this.specialAbilityActive) {
                    return;
                }
                
                // Ë∑ùÈõ¢„Å´Âøú„Åò„ÅüË°åÂãïÈÅ∏Êäû
                const isOpponentAttacking = opponent.isAttacking || opponent.specialAbilityActive;
                const isOpponentRecovering = opponent.isAttacking && opponent.attackFrame > (opponent.attacks[opponent.attackType]?.startup || 0) + 5;
                
                if (distance > 250) {
                    // ÈÅ†Ë∑ùÈõ¢ÔºöÊé•Ëøë
                    this.aiState = 'approach';
                } else if (distance < 90 && !isOpponentAttacking && this.onGround) {
                    // ËøëË∑ùÈõ¢ÔºöÊîªÊíÉ„ÉÅ„É£„É≥„Çπ
                    this.aiState = 'attack';
                } else if (isOpponentAttacking && distance < 120) {
                    // Áõ∏Êâã„ÅåÊîªÊíÉ‰∏≠ÔºöÈò≤Âæ°
                    this.aiState = 'defend';
                } else if (distance < 70 && opponent.comboCount > 2) {
                    // Áõ∏Êâã„Åå„Ç≥„É≥„Éú‰∏≠ÔºöÂæåÈÄÄ
                    this.aiState = 'retreat';
                } else if (distance < 100 && !this.onGround && !this.isAttacking) {
                    // Á©∫‰∏≠„Å´„ÅÑ„ÇãÊôÇÔºöÁ©∫‰∏≠ÊîªÊíÉ
                    this.aiState = 'air_attack';
                } else {
                    this.aiState = 'idle';
                }
                
                // Ë°åÂãï„ÅÆÂÆüË°å
                switch(this.aiState) {
                    case 'approach':
                        // Êé•Ëøë
                        if (opponent.x > this.x) {
                            keys[this.controls.right] = true;
                        } else {
                            keys[this.controls.left] = true;
                        }
                        
                        // „Åü„Åæ„Å´„Ç∏„É£„É≥„Éó„ÅßÊé•ËøëÔºà10%„ÅÆÁ¢∫ÁéáÔºâ
                        if (Math.random() < 0.1 && this.onGround) {
                            keys[this.controls.up] = true;
                            this.aiReactionTime = 5;
                        }
                        this.aiActionCooldown = 5 + Math.floor(Math.random() * 5);
                        break;
                        
                    case 'attack':
                        // ÊîªÊíÉ
                        const attackRand = Math.random();
                        const healthRatio = this.health / this.maxHealth;
                        
                        // ‰ΩìÂäõ„ÅåÂ∞ë„Å™„ÅÑÊôÇ„ÅØÂøÖÊÆ∫ÊäÄ„Çí‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ
                        if (attackRand < 0.35 && !this.isAttacking) {
                            // „Éë„É≥„ÉÅ
                            keys[this.controls.punch] = true;
                            this.aiActionCooldown = 15 + Math.floor(Math.random() * 10);
                            this.aiReactionTime = 3 + Math.floor(Math.random() * 3);
                        } else if (attackRand < 0.65 && !this.isAttacking) {
                            // „Ç≠„ÉÉ„ÇØ
                            keys[this.controls.kick] = true;
                            this.aiActionCooldown = 20 + Math.floor(Math.random() * 10);
                            this.aiReactionTime = 3 + Math.floor(Math.random() * 3);
                        } else if (attackRand < 0.8 && !this.isAttacking && healthRatio < 0.5 && Math.random() < 0.4) {
                            // ÂøÖÊÆ∫ÊäÄÔºà‰ΩìÂäõ„Åå50%‰ª•‰∏ã„Åß40%„ÅÆÁ¢∫ÁéáÔºâ
                            this.executeSpecialMove(this.getRandomSpecialMove());
                            this.aiActionCooldown = 30 + Math.floor(Math.random() * 15);
                            this.aiReactionTime = 5;
                        } else if (!this.onGround && !this.isAttacking) {
                            // Á©∫‰∏≠ÊîªÊíÉ
                            keys[this.controls.punch] = true;
                            this.aiActionCooldown = 12 + Math.floor(Math.random() * 8);
                            this.aiReactionTime = 2;
                        } else {
                            // ÁßªÂãï„Åó„Å™„Åå„ÇâÊîªÊíÉÊ∫ñÂÇô
                            if (distance > 60 && opponent.x > this.x) {
                                keys[this.controls.right] = true;
                            } else if (distance > 60 && opponent.x < this.x) {
                                keys[this.controls.left] = true;
                            }
                            this.aiActionCooldown = 8 + Math.floor(Math.random() * 5);
                        }
                        break;
                        
                    case 'defend':
                        // Èò≤Âæ°
                        const guardChance = 0.8; // 80%„ÅÆÁ¢∫Áéá„Åß„Ç¨„Éº„Éâ
                        if (Math.random() < guardChance) {
                            keys[this.controls.down] = true;
                            this.aiActionCooldown = 15 + Math.floor(Math.random() * 10);
                            this.aiReactionTime = 3 + Math.floor(Math.random() * 3);
                        } else {
                            // „Ç¨„Éº„Éâ„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÄÅÂæåÈÄÄ
                            if (opponent.x > this.x) {
                                keys[this.controls.left] = true;
                            } else {
                                keys[this.controls.right] = true;
                            }
                            this.aiActionCooldown = 10;
                        }
                        
                        // „Ç´„Ç¶„É≥„Çø„Éº„ÅÆÂèØËÉΩÊÄßÔºàZen„ÅÆÂ†¥Âêà„ÅØÈ´òÁ¢∫ÁéáÔºâ
                        if (isOpponentRecovering && distance < 100 && !this.isAttacking) {
                            if (this.charType === 'zen' && Math.random() < 0.5) {
                                // Zen„ÅØÈ´òÁ¢∫Áéá„Åß„Ç´„Ç¶„É≥„Çø„Éº
                                keys[this.controls.kick] = true;
                                this.aiActionCooldown = 12;
                                this.aiReactionTime = 2;
                            } else if (Math.random() < 0.25) {
                                // „Åù„ÅÆ‰ªñ„ÅÆ„Ç≠„É£„É©„ÅØ25%„ÅÆÁ¢∫Áéá
                                keys[this.controls.punch] = true;
                                this.aiActionCooldown = 12;
                                this.aiReactionTime = 3;
                            }
                        }
                        break;
                        
                    case 'retreat':
                        // ÂæåÈÄÄ
                        if (opponent.x > this.x) {
                            keys[this.controls.left] = true;
                        } else {
                            keys[this.controls.right] = true;
                        }
                        
                        // „Ç∏„É£„É≥„Éó„ÅßÂõûÈÅøÔºà30%„ÅÆÁ¢∫ÁéáÔºâ
                        if (Math.random() < 0.3 && this.onGround) {
                            keys[this.controls.up] = true;
                            this.aiReactionTime = 5;
                        }
                        this.aiActionCooldown = 12 + Math.floor(Math.random() * 8);
                        break;
                        
                    case 'air_attack':
                        // Á©∫‰∏≠ÊîªÊíÉ
                        if (!this.isAttacking) {
                            keys[this.controls.punch] = true;
                            this.aiActionCooldown = 10 + Math.floor(Math.random() * 5);
                            this.aiReactionTime = 2;
                        }
                        break;
                        
                    case 'idle':
                        // ÂæÖÊ©üÔºà„Åü„Åæ„Å´ÁßªÂãïÔºâ
                        if (Math.random() < 0.15) {
                            if (distance > 150) {
                                // ÈÅ†„ÅÑÊôÇ„ÅØÊé•Ëøë
                                if (opponent.x > this.x) {
                                    keys[this.controls.right] = true;
                                } else {
                                    keys[this.controls.left] = true;
                                }
                            } else if (distance < 80) {
                                // Ëøë„ÅÑÊôÇ„ÅØÂæåÈÄÄ
                                if (opponent.x > this.x) {
                                    keys[this.controls.left] = true;
                                } else {
                                    keys[this.controls.right] = true;
                                }
                            }
                            this.aiActionCooldown = 8 + Math.floor(Math.random() * 5);
                        } else {
                            this.aiActionCooldown = 10 + Math.floor(Math.random() * 10);
                        }
                        break;
                }
            }
            
            getRandomSpecialMove() {
                // „Ç≠„É£„É©„ÇØ„Çø„Éº„Åî„Å®„ÅÆÂøÖÊÆ∫ÊäÄÂêç„ÇíËøî„Åô
                switch(this.charType) {
                    case 'ash': return 'ultimate_impact';
                    case 'cyberK': return 'middle_kick';
                    case 'granite': return 'granite_press';
                    case 'mystia': return 'mujihi_hoyo';
                    case 'zen': return 'kuusemi_gaashi';
                    case 'universal': return 'emergency_step';
                    default: return 'ultimate_impact';
                }
            }
            
            startAttack(type) {
                this.isAttacking = true;
                this.attackType = type;
                this.attackFrame = 0;
                this.lastHitConnected = false; // Êñ∞„Åó„ÅÑÊîªÊíÉÈñãÂßãÊôÇ„Å´„É™„Çª„ÉÉ„Éà
            }
            
            canCancelAttack(attack) {
                // „Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Éï„É¨„Éº„É†ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (!attack.cancelWindow || !this.lastHitConnected) {
                    return false;
                }
                const cancelStart = attack.startup + attack.cancelWindow.start;
                const cancelEnd = attack.startup + attack.cancelWindow.end;
                return this.attackFrame >= cancelStart && this.attackFrame <= cancelEnd;
            }
            
            checkCancelInput() {
                // ÂÖ•Âäõ„Å´Âøú„Åò„Å¶„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ„Å™ÊäÄ„ÇíËøî„Åô
                const attack = this.attacks[this.attackType];
                if (!attack.cancellableInto) return null;
                
                // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•Âæå„ÅÆÁ¢∫ÂÆö„Ç≥„É≥„Éú„ÅØÂøÖÊÆ∫ÊäÄ„Å´„ÇÇ„Ç≠„É£„É≥„Çª„É´ÂèØËÉΩ
                if (this.guardCrushComboReady && keys[this.controls.special]) {
                    // „Ç≥„Éû„É≥„ÉâÂÖ•Âäõ„ÉÅ„Çß„ÉÉ„ÇØ
                    const command = this.checkCommand();
                    if (command) {
                        this.guardCrushComboReady = false; // ‰ΩøÁî®Ê∏à„Åø
                        return null; // executeSpecialMove„ÅåÂëº„Å∞„Çå„Çã
                    }
                }
                
                // ÈÄöÂ∏∏„ÅÆ„Ç≠„É£„É≥„Çª„É´ÂÖ•Âäõ„ÉÅ„Çß„ÉÉ„ÇØ
                for (const cancelType of attack.cancellableInto) {
                    if (cancelType === 'kick' && keys[this.controls.kick]) {
                        return 'kick';
                    } else if (cancelType === 'punch' && keys[this.controls.punch]) {
                        return 'punch';
                    } else if (cancelType === 'special' && keys[this.controls.special]) {
                        // ÂøÖÊÆ∫ÊäÄ„ÅØ„Ç≥„Éû„É≥„ÉâÂÖ•Âäõ„ÅåÂøÖË¶Å
                        const command = this.checkCommand();
                        if (command) {
                            return null; // executeSpecialMove„ÅåÂëº„Å∞„Çå„Çã
                        }
                    }
                }
                return null;
            }
            
            startSpecialAbility(type) {
                this.specialAbilityActive = true;
                this.specialAbilityType = type;
                this.specialAbilityFrame = 0;
                this.vx = 0; // ÁßªÂãï„ÇíÂÅúÊ≠¢
            }
            
            updateSpecialAbility() {
                this.specialAbilityFrame++;
                const opponent = this === player1 ? player2 : player1;
                
                switch (this.specialAbilityType) {
                    case 'throw': // Granite„ÅÆÊäï„ÅíÊäÄ
                        if (this.specialAbilityFrame === 10) {
                            // Êäï„ÅíÊäÄÁô∫Âãï
                            const distance = Math.abs(this.x - opponent.x);
                            if (distance < 60) {
                                const throwDamage = 35;
                                opponent.health -= throwDamage; // È´ò„ÉÄ„É°„Éº„Ç∏
                                if (opponent.health < 0) opponent.health = 0;
                                opponent.x += this.facing * 50; // Â§ß„Åç„Åè„Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØ
                                opponent.y -= 20; // ÊµÆ„Åã„Åõ„Çã
                                opponent.vy = -8;
                                opponent.stunned = 40; // Èï∑„ÅÑ„Çπ„Çø„É≥
                                
                                // „ÉÄ„É°„Éº„Ç∏Êï∞Â≠ó
                                damageNumbers.push(new DamageNumber(
                                    opponent.x + opponent.width / 2,
                                    opponent.y + 30,
                                    throwDamage,
                                    true, // Êäï„ÅíÊäÄ„ÅØ„ÇØ„É™„ÉÜ„Ç£„Ç´„É´
                                    1
                                ));
                                
                                // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ„Å®„Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥
                                shakeCamera(12, 18);
                                startSlowMotion(0.4, 25);
                                
                                // Êäï„Åí„Ç®„Éï„Çß„ÇØ„Éà
                                for (let i = 0; i < 40; i++) {
                                    particles.push(new Particle(opponent.x, opponent.y + 40, '#888'));
                                }
                            }
                        }
                        if (this.specialAbilityFrame >= 40) {
                            this.specialAbilityActive = false;
                            this.specialAbilityType = null;
                        }
                        break;
                        
                    case 'evade': // Universal„ÅÆÁ∑äÊÄ•ÂõûÈÅø
                        if (this.specialAbilityFrame === 1) {
                            // „Éê„ÉÉ„ÇØ„Çπ„ÉÜ„ÉÉ„Éó
                            this.vx = -this.facing * 15;
                            this.invincible = 20; // ÁÑ°ÊïµÊôÇÈñì
                            this.evadeFrames = 20;
                        }
                        if (this.specialAbilityFrame >= 15) {
                            this.specialAbilityActive = false;
                            this.specialAbilityType = null;
                            this.vx = 0;
                        }
                        if (this.evadeFrames > 0) {
                            this.evadeFrames--;
                        }
                        break;
                        
                    case 'hug': // Mystia„ÅÆÊä±ÊìÅÊäÄ
                        if (this.specialAbilityFrame === 8) {
                            const distance = Math.abs(this.x - opponent.x);
                            if (distance < 70) {
                                const hugDamage = 20;
                                opponent.health -= hugDamage;
                                if (opponent.health < 0) opponent.health = 0;
                                opponent.stunned = 25;
                                
                                // „ÉÄ„É°„Éº„Ç∏Êï∞Â≠ó
                                damageNumbers.push(new DamageNumber(
                                    (this.x + opponent.x) / 2,
                                    (this.y + opponent.y) / 2 - 20,
                                    hugDamage,
                                    false,
                                    1
                                ));
                                
                                // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ
                                shakeCamera(6, 10);
                                
                                // Êä±ÊìÅ„Ç®„Éï„Çß„ÇØ„Éà
                                for (let i = 0; i < 30; i++) {
                                    particles.push(new Particle((this.x + opponent.x) / 2, (this.y + opponent.y) / 2, '#f4f'));
                                }
                            }
                        }
                        if (this.specialAbilityFrame >= 30) {
                            this.specialAbilityActive = false;
                            this.specialAbilityType = null;
                        }
                        break;
                }
            }
            
            performAttack() {
                const attack = this.attacks[this.attackType];
                const opponent = this === player1 ? player2 : player1;
                
                const distance = Math.abs(this.x - opponent.x);
                const attackReach = attack.range;
                
                // ÊîªÊíÉÂà§ÂÆöÔºàÂêë„ÅçÂà§ÂÆö„ÇÇÂê´„ÇÄÔºâ
                const isFacingOpponent = (this.x < opponent.x && this.facing === 1) || 
                                         (this.x > opponent.x && this.facing === -1);
                
                let hitResult = { hit: false };
                
                if (distance < attackReach && 
                    Math.abs(this.y - opponent.y) < 50 &&
                    opponent.invincible === 0) {
                    
                    hitResult.hit = true;
                    
                    let damage = attack.damage;
                    let hitType = 'normal'; // 'guard', 'normal', 'back'
                    let hitStopFrames = 0;
                    
                    // Âêë„ÅçÂà§ÂÆöÔºöËÉåÈù¢ÊîªÊíÉ„Åß„ÉÄ„É°„Éº„Ç∏Â¢óÂä†
                    const isBackAttack = !isFacingOpponent;
                    if (isBackAttack) {
                        damage *= 1.5; // ËÉåÈù¢ÊîªÊíÉ„ÅØ1.5ÂÄç
                        hitType = 'back';
                    }
                    
                    // „Ç¨„Éº„ÉâÂà§ÂÆö
                    const isGuarding = opponent.isBlocking && !opponent.guardCrushed && 
                                       ((opponent.x < this.x && opponent.facing === 1) || 
                                        (opponent.x > this.x && opponent.facing === -1));
                    
                    if (isGuarding) {
                        // „Ç¨„Éº„ÉâÊàêÂäü
                        damage *= 0.3;
                        hitType = 'guard';
                        
                        // „Ç¨„Éº„Éâ„Ç≤„Éº„Ç∏Ê∏õÂ∞ë
                        const guardDamage = attack.damage * 0.15; // „Ç¨„Éº„Éâ„Åß„ÇÇ„Ç≤„Éº„Ç∏„ÉÄ„É°„Éº„Ç∏
                        opponent.guardGauge -= guardDamage;
                        if (opponent.guardGauge < 0) {
                            opponent.guardGauge = 0;
                            opponent.guardCrushed = true;
                            opponent.guardCrushedTime = 120; // 2ÁßíÈñì„Ç¨„Éº„Éâ‰∏çÂèØ
                            opponent.stunned = 30; // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•ÊôÇ„ÅØ„Çπ„Çø„É≥
                            hitType = 'guardCrush';
                            playGuardCrushSound();
                            // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•Âæå„ÅØÁ¢∫ÂÆö„Ç≥„É≥„ÉúÂèØËÉΩ
                            this.guardCrushComboReady = true;
                            this.lastHitConnected = true;
                        } else {
                            playGuardSound();
                        }
                        
                        // Ë∂ÖÂøÖÊÆ∫ÊäÄ„Ç≤„Éº„Ç∏Â¢óÂä†Ôºà„Ç¨„Éº„ÉâÊôÇÔºâ
                        this.superGauge = Math.min(this.maxSuperGauge, this.superGauge + this.superGaugeGainOnBlock);
                        
                        this.createParticles(opponent.x, opponent.y + 40, '#ff0', 5);
                        hitStopFrames = 3; // „Ç¨„Éº„ÉâÊôÇ„ÅØËªΩ„ÅÑ„Éí„ÉÉ„Éà„Çπ„Éà„ÉÉ„Éó
                    } else {
                        // ÈÄöÂ∏∏„Éí„ÉÉ„Éà
                        opponent.stunned = this.getStunFrames(attack);
                        this.createParticles(opponent.x, opponent.y + 40, '#f44', 10);
                        
                        // „Éí„ÉÉ„Éà„Éï„É©„Ç∞„ÅØperformAttack()„ÅÆÊàª„ÇäÂÄ§„ÅßË®≠ÂÆö„Åï„Çå„ÇãÔºàÂëº„Å≥Âá∫„ÅóÂÅ¥„ÅßÂá¶ÁêÜÔºâ
                        
                        // „Ç∏„É£„É≥„ÉóÊîªÊíÉ„ÅÆÂà§ÂÆö
                        if (!this.onGround && (this.attackType === 'punch' || this.attackType === 'kick')) {
                            this.jumpAttackHit = true;
                            this.airComboReady = true; // ÁùÄÂú∞Âæå„Å´ËøΩÊíÉÂèØËÉΩ
                            opponent.vy = -5; // Â∞ë„ÅóÊµÆ„Åã„Åõ„ÇãÔºàËøΩÊíÉ„Åó„ÇÑ„Åô„Åè„Åô„ÇãÔºâ
                        }
                        
                        // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•Âæå„ÅÆÁ¢∫ÂÆö„Ç≥„É≥„ÉúÂèØËÉΩÁä∂ÊÖã
                        if (opponent.guardCrushed) {
                            this.guardCrushComboReady = true;
                        }
                        
                        // „Éí„ÉÉ„ÉàÊôÇ„Å´Áõ∏Êâã„ÅÆ„Ç´„Ç¶„É≥„Çø„ÉºÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                        if (opponent.charType === 'zen') {
                            opponent.counterReady = false;
                        }
                        
                        // „Ç≥„É≥„Éú„Ç∑„Çπ„ÉÜ„É†
                        if (this.comboTimer > 0) {
                            // „Ç≥„É≥„Éú„Ç¶„Ç£„É≥„Éâ„Ç¶ÂÜÖ„Å™„Çâ„Ç≥„É≥„ÉúÁ∂ôÁ∂ö
                            this.comboCount++;
                            this.comboTimer = this.comboWindow;
                        } else {
                            // Êñ∞Ë¶è„Ç≥„É≥„ÉúÈñãÂßã
                            this.comboCount = 1;
                            this.comboTimer = this.comboWindow;
                        }
                        
                        // „Ç≥„É≥„Éú„Å´„Çà„Çã„ÉÄ„É°„Éº„Ç∏ÂÄçÁéá
                        const comboMultiplier = 1 + (this.comboCount - 1) * 0.1; // 2„Éí„ÉÉ„ÉàÁõÆ„Åã„Çâ10%„Åö„Å§Â¢óÂä†
                        damage *= Math.min(comboMultiplier, 2.0); // ÊúÄÂ§ß2ÂÄç
                        
                        // Ë∂ÖÂøÖÊÆ∫ÊäÄ„Ç≤„Éº„Ç∏Â¢óÂä†ÔºàÊîªÊíÉÂëΩ‰∏≠ÊôÇÔºâ
                        this.superGauge = Math.min(this.maxSuperGauge, this.superGauge + this.superGaugeGainOnHit);
                        
                        // „Éí„ÉÉ„Éà„Çπ„Éà„ÉÉ„Éó„ÅÆË®àÁÆóÔºàÊîªÊíÉ„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶Ôºâ
                        hitStopFrames = this.getHitStopFrames(attack);
                        
                        // Áõ∏Êâã„ÅÆ„Ç≥„É≥„Éú„Çí„É™„Çª„ÉÉ„Éà
                        opponent.comboCount = 0;
                        opponent.comboTimer = 0;
                    }
                    
                    opponent.health -= damage;
                    if (opponent.health < 0) opponent.health = 0;
                    
                    // Ë∂ÖÂøÖÊÆ∫ÊäÄ„Ç≤„Éº„Ç∏Â¢óÂä†ÔºàË¢´ÂºæÊôÇÔºâ
                    opponent.superGauge = Math.min(opponent.maxSuperGauge, opponent.superGauge + opponent.superGaugeGainOnDamage);
                    
                    // „ÉÄ„É°„Éº„Ç∏Êï∞Â≠ó„ÇíË°®Á§∫
                    const isCritical = hitType === 'back' || damage >= 20 || this.comboCount >= 5;
                    damageNumbers.push(new DamageNumber(
                        opponent.x + opponent.width / 2,
                        opponent.y + 30,
                        damage,
                        isCritical,
                        this.comboCount
                    ));
                    
                    // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫
                    if (isCritical) {
                        criticalTexts.push(new CriticalText(
                            opponent.x + opponent.width / 2,
                            opponent.y,
                            'CRITICAL!'
                        ));
                    }
                    
                    // „Éí„ÉÉ„ÉàÈü≥ÂÜçÁîü
                    playHitSound(isCritical);
                    
                    // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ
                    if (hitType === 'guardCrush') {
                        shakeCamera(15, 20);
                        startSlowMotion(0.3, 30); // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•ÊôÇ„ÅØ„Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥
                    } else if (hitType === 'back' || damage >= 25) {
                        shakeCamera(10, 15);
                        startSlowMotion(0.5, 20);
                    } else if (this.attackType === 'special') {
                        shakeCamera(8, 12);
                        startSlowMotion(0.6, 15);
                    } else if (damage >= 15) {
                        shakeCamera(5, 8);
                    } else {
                        shakeCamera(3, 5);
                    }
                    
                    // „Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØÔºàÊîªÊíÉ„Çø„Ç§„Éó„Å®„Éí„ÉÉ„Éà„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶Ôºâ
                    const knockbackX = this.getKnockbackX(attack, hitType);
                    const knockbackY = this.getKnockbackY(attack, hitType);
                    opponent.x += this.facing * knockbackX;
                    opponent.vy = knockbackY;
                    
                    // „Éí„ÉÉ„Éà„Çπ„Éà„ÉÉ„ÉóÈÅ©Áî®
                    if (hitStopFrames > 0 && hitType !== 'guard') {
                        player1.hitStopActive = true;
                        player1.hitStopFrames = hitStopFrames;
                        player2.hitStopActive = true;
                        player2.hitStopFrames = hitStopFrames;
                    }
                    
                    // „Ç®„Éï„Çß„ÇØ„ÉàÔºàË¶ñË¶öÁöÑË°®ÁèæÔºâ
                    if (this.attackType === 'special') {
                        this.createSpecialEffect(opponent, hitType);
                    } else if (hitType === 'back') {
                        this.createParticles(opponent.x, opponent.y + 40, '#f0f', 15); // ËÉåÈù¢ÊîªÊíÉ„ÅØÁ¥´„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
                    } else if (hitType === 'guardCrush') {
                        this.createParticles(opponent.x, opponent.y + 40, '#f00', 20); // „Ç¨„Éº„Éâ„ÇØ„É©„ÉÉ„Ç∑„É•„ÅØËµ§„ÅÑ„Ç®„Éï„Çß„ÇØ„Éà
                    }
                }
                
                return hitResult;
            }
            
            performSuperMove() {
                // Ë∂ÖÂøÖÊÆ∫ÊäÄ„ÅÆÊîªÊíÉÂà§ÂÆö
                const charData = characterData[this.charType];
                const superMove = charData.superMove;
                const opponent = this === player1 ? player2 : player1;
                
                const distance = Math.abs(this.x - opponent.x);
                const attackReach = superMove.range;
                
                if (distance < attackReach && 
                    Math.abs(this.y - opponent.y) < 60 &&
                    opponent.invincible === 0) {
                    
                    let damage = superMove.damage;
                    let hitType = 'super';
                    
                    // „Ç¨„Éº„ÉâÂà§ÂÆö
                    const isGuarding = opponent.isBlocking && !opponent.guardCrushed && 
                                       ((opponent.x < this.x && opponent.facing === 1) || 
                                        (opponent.x > this.x && opponent.facing === -1));
                    
                    if (isGuarding) {
                        // „Ç¨„Éº„ÉâÊàêÂäüÔºàË∂ÖÂøÖÊÆ∫ÊäÄ„ÅØ„Ç¨„Éº„ÉâÊôÇ„Åß„ÇÇÈ´ò„ÉÄ„É°„Éº„Ç∏Ôºâ
                        damage *= 0.5;
                        hitType = 'guard';
                        playGuardSound();
                    } else {
                        // ÈÄöÂ∏∏„Éí„ÉÉ„Éà
                        opponent.stunned = 40; // Èï∑„ÅÑ„Çπ„Çø„É≥
                        this.createParticles(opponent.x, opponent.y + 40, this.color, 30);
                        
                        // „Ç≥„É≥„Éú„Ç∑„Çπ„ÉÜ„É†
                        if (this.comboTimer > 0) {
                            this.comboCount++;
                            this.comboTimer = this.comboWindow;
                        } else {
                            this.comboCount = 1;
                            this.comboTimer = this.comboWindow;
                        }
                        
                        // Ë∂ÖÂøÖÊÆ∫ÊäÄ„ÅØÂ∏∏„Å´„ÇØ„É™„ÉÜ„Ç£„Ç´„É´
                        damage *= 1.3;
                    }
                    
                    opponent.health -= damage;
                    if (opponent.health < 0) opponent.health = 0;
                    
                    // „ÉÄ„É°„Éº„Ç∏Êï∞Â≠ó
                    damageNumbers.push(new DamageNumber(
                        opponent.x + opponent.width / 2,
                        opponent.y + 30,
                        damage,
                        true, // Â∏∏„Å´„ÇØ„É™„ÉÜ„Ç£„Ç´„É´
                        this.comboCount
                    ));
                    
                    // Ë∂ÖÂøÖÊÆ∫ÊäÄ„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫
                    criticalTexts.push(new CriticalText(
                        opponent.x + opponent.width / 2,
                        opponent.y - 30,
                        this.superMoveName + '!'
                    ));
                    
                    // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ„Å®„Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥
                    shakeCamera(20, 40);
                    startSlowMotion(0.2, 50);
                    
                    // „Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØ
                    opponent.x += this.facing * 40;
                    opponent.vy = -12;
                    
                    // „Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 60; i++) {
                        particles.push(new Particle(opponent.x, opponent.y + 40, this.color));
                    }
                    
                    // „Éí„ÉÉ„ÉàÈü≥
                    playHitSound(true);
                }
            }
            
            getStunFrames(attack) {
                // ÊîªÊíÉ„Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Çπ„Çø„É≥ÊôÇÈñì
                if (attack === this.attacks.punch) return 8;
                if (attack === this.attacks.kick) return 12;
                if (attack === this.attacks.special) return 20;
                return 10;
            }
            
            getHitStopFrames(attack) {
                // ÊîªÊíÉ„Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Éí„ÉÉ„Éà„Çπ„Éà„ÉÉ„ÉóÊôÇÈñì
                if (this.attackType === 'punch') return 5;
                if (this.attackType === 'kick') return 8;
                if (this.attackType === 'special') return 12;
                return 5;
            }
            
            getKnockbackX(attack, hitType) {
                // „Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØÈáèÔºàXËª∏Ôºâ
                let baseKnockback = 15;
                if (this.attackType === 'punch') baseKnockback = 12;
                if (this.attackType === 'kick') baseKnockback = 18;
                if (this.attackType === 'special') baseKnockback = 25;
                
                if (hitType === 'guard') baseKnockback *= 0.5;
                if (hitType === 'back') baseKnockback *= 1.2;
                if (hitType === 'guardCrush') baseKnockback *= 1.5;
                
                return baseKnockback;
            }
            
            getKnockbackY(attack, hitType) {
                // „Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØÈáèÔºàYËª∏Ôºâ
                let baseKnockback = -5;
                if (this.attackType === 'kick') baseKnockback = -7;
                if (this.attackType === 'special') baseKnockback = -10;
                
                if (hitType === 'guardCrush') baseKnockback = -8;
                
                return baseKnockback;
            }
            
            createParticles(x, y, color, count) {
                for (let i = 0; i < count; i++) {
                    particles.push(new Particle(x, y, color));
                }
            }
            
            createSpecialEffect(opponent, hitType) {
                // ÂøÖÊÆ∫ÊäÄ„Ç®„Éï„Çß„ÇØ„Éà
                const effectCount = hitType === 'guardCrush' ? 50 : 30;
                for (let i = 0; i < effectCount; i++) {
                    particles.push(new Particle(opponent.x, opponent.y + 40, this.color));
                }
            }
            
            draw() {
                ctx.save();
                
                // „Çπ„Çø„É≥ÊôÇÁÇπÊªÖ
                if (this.stunned > 0 && Math.floor(this.stunned / 3) % 2 === 0) {
                    ctx.globalAlpha = 0.5;
                }
                
                // ÁÑ°ÊïµÊôÇ„Ç™„Éº„É©
                if (this.invincible > 0) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = this.color;
                }
                
                const centerX = this.x + this.width / 2;
                const headY = this.y + 15;
                const bodyY = this.y + 45;
                const legY = this.y + this.height - 15;
                
                // È†≠
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(centerX, headY, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // ‰Ωì
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';
                
                // ËÉ¥‰Ωì
                ctx.beginPath();
                ctx.moveTo(centerX, headY + 15);
                ctx.lineTo(centerX, bodyY + 15);
                ctx.stroke();
                
                // ÁâπÊÆäËÉΩÂäõ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                if (this.specialAbilityActive) {
                    this.drawSpecialAbilityPose(centerX, headY, bodyY, legY);
                } else if (this.superMoveActive) {
                    this.drawSuperMovePose(centerX, headY, bodyY, legY);
                } else if (this.isAttacking) {
                    this.drawAttackPose(centerX, headY, bodyY, legY);
                } else if (this.isBlocking) {
                    this.drawBlockPose(centerX, headY, bodyY, legY);
                } else if (!this.onGround) {
                    this.drawJumpPose(centerX, headY, bodyY, legY);
                } else if (Math.abs(this.vx) > 0) {
                    this.drawWalkPose(centerX, headY, bodyY, legY);
                } else {
                    this.drawIdlePose(centerX, headY, bodyY, legY);
                }
                
                // Zen„ÅÆ„Ç´„Ç¶„É≥„Çø„ÉºÊ∫ñÂÇôÁä∂ÊÖã„ÅÆË°®Á§∫
                if (this.charType === 'zen' && this.counterReady && this.isBlocking) {
                    ctx.save();
                    ctx.globalAlpha = 0.5;
                    ctx.strokeStyle = '#ff4';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(centerX, bodyY, 25, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                }
                
                // Universal„ÅÆÂõûÈÅø‰∏≠„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
                if (this.charType === 'universal' && this.invincible > 0 && this.evadeFrames > 0) {
                    ctx.save();
                    ctx.globalAlpha = 0.6;
                    ctx.strokeStyle = '#4f4';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(centerX, bodyY, 30, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                }
                
                ctx.restore();
            }
            
            drawIdlePose(cx, headY, bodyY, legY) {
                const breathe = Math.sin(this.animFrame) * 2;
                
                // ËÖï
                ctx.beginPath();
                ctx.moveTo(cx, bodyY - 5);
                ctx.lineTo(cx - this.facing * 15, bodyY + 10 + breathe);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(cx, bodyY - 5);
                ctx.lineTo(cx + this.facing * 15, bodyY + 10 + breathe);
                ctx.stroke();
                
                // ËÑö
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx - 10, legY);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx + 10, legY);
                ctx.stroke();
            }
            
            drawWalkPose(cx, headY, bodyY, legY) {
                const walk = Math.sin(this.animFrame * 3) * 15;
                
                // ËÖï
                ctx.beginPath();
                ctx.moveTo(cx, bodyY - 5);
                ctx.lineTo(cx - this.facing * 10, bodyY + 15 + walk);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(cx, bodyY - 5);
                ctx.lineTo(cx + this.facing * 10, bodyY + 15 - walk);
                ctx.stroke();
                
                // ËÑö
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx - 10, legY - Math.abs(walk));
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx + 10, legY - Math.abs(-walk));
                ctx.stroke();
            }
            
            drawJumpPose(cx, headY, bodyY, legY) {
                // ËÖï
                ctx.beginPath();
                ctx.moveTo(cx, bodyY - 5);
                ctx.lineTo(cx - this.facing * 20, bodyY - 10);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(cx, bodyY - 5);
                ctx.lineTo(cx + this.facing * 20, bodyY - 10);
                ctx.stroke();
                
                // ËÑö
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx - 15, legY - 10);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx + 15, legY - 10);
                ctx.stroke();
            }
            
            drawBlockPose(cx, headY, bodyY, legY) {
                // ËÖïÔºàÈò≤Âæ°Ôºâ
                ctx.beginPath();
                ctx.moveTo(cx, bodyY - 5);
                ctx.lineTo(cx - this.facing * 20, headY + 20);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(cx, bodyY - 5);
                ctx.lineTo(cx + this.facing * 20, headY + 20);
                ctx.stroke();
                
                // ËÑö
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx - 12, legY);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx + 12, legY);
                ctx.stroke();
            }
            
            drawAttackPose(cx, headY, bodyY, legY) {
                const progress = this.attackFrame / (this.attacks[this.attackType].startup + this.attacks[this.attackType].recovery);
                const extend = Math.sin(progress * Math.PI) * 30;
                
                if (this.attackType === 'punch' || this.attackType === 'special') {
                    // „Éë„É≥„ÉÅ
                    ctx.beginPath();
                    ctx.moveTo(cx, bodyY - 5);
                    ctx.lineTo(cx + this.facing * (25 + extend), bodyY);
                    ctx.stroke();
                    
                    // „ÇÇ„ÅÜÁâáÊñπ„ÅÆËÖï
                    ctx.beginPath();
                    ctx.moveTo(cx, bodyY - 5);
                    ctx.lineTo(cx - this.facing * 10, bodyY + 10);
                    ctx.stroke();
                    
                    // „Ç®„Éï„Çß„ÇØ„Éà
                    if (this.attackFrame === this.attacks[this.attackType].startup) {
                        const effectX = cx + this.facing * (25 + extend);
                        for (let i = 0; i < 3; i++) {
                            ctx.fillStyle = this.color;
                            ctx.globalAlpha = 0.5;
                            ctx.beginPath();
                            ctx.arc(effectX + this.facing * i * 10, bodyY, 8 - i * 2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                } else {
                    // „Ç≠„ÉÉ„ÇØ
                    ctx.beginPath();
                    ctx.moveTo(cx, bodyY + 15);
                    ctx.lineTo(cx + this.facing * (20 + extend), bodyY + 10);
                    ctx.stroke();
                    
                    // „ÇÇ„ÅÜÁâáÊñπ„ÅÆËÑö
                    ctx.beginPath();
                    ctx.moveTo(cx, bodyY + 15);
                    ctx.lineTo(cx - this.facing * 5, legY);
                    ctx.stroke();
                    
                    // „Ç®„Éï„Çß„ÇØ„Éà
                    if (this.attackFrame === this.attacks[this.attackType].startup) {
                        const effectX = cx + this.facing * (20 + extend);
                        for (let i = 0; i < 3; i++) {
                            ctx.fillStyle = this.color;
                            ctx.globalAlpha = 0.5;
                            ctx.beginPath();
                            ctx.arc(effectX + this.facing * i * 10, bodyY + 10, 8 - i * 2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
                
                // ËÖïÔºàÊîªÊíÉ„Åó„Å¶„ÅÑ„Å™„ÅÑÊñπÔºâ
                ctx.beginPath();
                ctx.moveTo(cx, bodyY - 5);
                ctx.lineTo(cx - this.facing * 15, bodyY + 5);
                ctx.stroke();
                
                // ËÑöÔºàÈÄöÂ∏∏Ôºâ
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx - 10, legY);
                ctx.stroke();
            }
            
            drawSpecialMoveAnimation(cx, headY, bodyY, legY, progress, extend) {
                // ÂøÖÊÆ∫ÊäÄ„Åî„Å®„ÅÆÂõ∫Êúâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                switch(this.specialMoveName) {
                    case 'ultimate_impact': // Ash
                        // Á™ÅÈÄ≤„Åô„Çã„Éë„É≥„ÉÅ
                        const dash = progress < 0.3 ? progress * 100 : (1 - progress) * 50;
                        this.x += this.facing * dash * 0.5;
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx + this.facing * (40 + extend * 1.5), bodyY);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx - this.facing * 5, bodyY + 5);
                        ctx.stroke();
                        break;
                        
                    case 'middle_kick': // Cyber-K
                        // Ê®™ÊñπÂêë„ÅÆÂ∫ÉÁØÑÂõ≤„Ç≠„ÉÉ„ÇØ
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx + this.facing * (30 + extend), bodyY);
                        ctx.lineTo(cx + this.facing * (35 + extend), bodyY - 5);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx - this.facing * 10, legY);
                        ctx.stroke();
                        break;
                        
                    case 'granite_press': // Granite
                        // Á™ÅÈÄ≤ÊäÄ
                        const graniteDash = progress < 0.4 ? progress * 120 : (1 - progress) * 30;
                        this.x += this.facing * graniteDash * 0.6;
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx + this.facing * (35 + extend), bodyY + 10);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx + this.facing * 20, bodyY + 15);
                        ctx.stroke();
                        break;
                        
                    case 'mujihi_hoyo': // Mystia
                        // ‰∏äÊÆµ„Ç≠„ÉÉ„ÇØÔºàËÜùËπ¥„ÇäÔºâ
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx + this.facing * 15, bodyY - 10);
                        ctx.lineTo(cx + this.facing * (20 + extend), bodyY - 15);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx - this.facing * 5, legY);
                        ctx.stroke();
                        break;
                        
                    case 'kuusemi_gaashi': // Zen
                        // ÂèçÊíÉÂûãÔºàÁ¥†Êó©„ÅÑÁ™Å„ÅçÔºâ
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx + this.facing * (30 + extend * 1.2), bodyY - 5);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx - this.facing * 15, bodyY);
                        ctx.stroke();
                        break;
                        
                    case 'emergency_step': // Universal
                        // ÂõûÈÅø„Åã„Çâ„ÅÆÂèçÊíÉ
                        const evadeStep = progress < 0.2 ? -30 : 20;
                        this.x += this.facing * evadeStep * 0.3;
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx + this.facing * (25 + extend), bodyY);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx - this.facing * 10, bodyY + 5);
                        ctx.stroke();
                        break;
                }
                
                // ËÑö
                ctx.beginPath();
                ctx.moveTo(cx, bodyY + 15);
                ctx.lineTo(cx - 10, legY);
                ctx.stroke();
                
                // ÂøÖÊÆ∫ÊäÄÂêçË°®Á§∫
                if (this.specialMoveNameFrames > 0 && this.attackFrame < 10) {
                    ctx.save();
                    ctx.translate(cx, headY - 40);
                    ctx.globalAlpha = Math.min(1, this.specialMoveNameFrames / 20);
                    ctx.fillStyle = this.color;
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 4;
                    ctx.font = 'bold 24px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const moveNames = {
                        'ultimate_impact': 'Ultimate Impact!',
                        'middle_kick': 'Middle Kick!',
                        'granite_press': 'Granite Press!',
                        'mujihi_hoyo': 'Mujihi na Hoyo!',
                        'kuusemi_gaashi': 'Kuusemi-gaashi!',
                        'emergency_step': 'Emergency Step!'
                    };
                    const moveName = moveNames[this.specialMoveName] || 'Special Move!';
                    ctx.strokeText(moveName, 0, 0);
                    ctx.fillText(moveName, 0, 0);
                    ctx.restore();
                }
                
                // ÂøÖÊÆ∫ÊäÄ„Ç®„Éï„Çß„ÇØ„Éà
                if (this.attackFrame === this.attacks[this.attackType].startup) {
                    const effectX = cx + this.facing * (30 + extend);
                    for (let i = 0; i < 5; i++) {
                        ctx.fillStyle = this.color;
                        ctx.globalAlpha = 0.6;
                        ctx.beginPath();
                        ctx.arc(effectX + this.facing * i * 15, bodyY, 12 - i * 2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
            
            drawSpecialAbilityPose(cx, headY, bodyY, legY) {
                switch (this.specialAbilityType) {
                    case 'throw': // Granite„ÅÆÊäï„ÅíÊäÄ
                        const throwProgress = this.specialAbilityFrame / 40;
                        // Êäï„Åí„Çã„Éù„Éº„Ç∫
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx + this.facing * 25, bodyY + 5 + Math.sin(throwProgress * Math.PI) * 10);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx - this.facing * 15, bodyY + 10);
                        ctx.stroke();
                        
                        // ËÑö
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx - 12, legY);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx + 12, legY);
                        ctx.stroke();
                        break;
                        
                    case 'evade': // Universal„ÅÆÁ∑äÊÄ•ÂõûÈÅø
                        // Âæå„Çç„Å´Ë∑≥„Å∂„Éù„Éº„Ç∫
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx + this.facing * 20, bodyY - 10);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx - this.facing * 20, bodyY - 10);
                        ctx.stroke();
                        
                        // ËÑö„ÇíÊõ≤„Åí„Åü„Éù„Éº„Ç∫
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx - 15, legY - 15);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx + 15, legY - 15);
                        ctx.stroke();
                        break;
                        
                    case 'hug': // Mystia„ÅÆÊä±ÊìÅÊäÄ
                        const hugProgress = this.specialAbilityFrame / 30;
                        // Êä±ÊìÅ„Åô„Çã„Éù„Éº„Ç∫
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx + this.facing * (20 + Math.sin(hugProgress * Math.PI) * 15), bodyY);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY - 5);
                        ctx.lineTo(cx - this.facing * (20 + Math.sin(hugProgress * Math.PI) * 15), bodyY);
                        ctx.stroke();
                        
                        // ËÑö
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx - 10, legY);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(cx, bodyY + 15);
                        ctx.lineTo(cx + 10, legY);
                        ctx.stroke();
                        break;
                }
            }
        }
        
        // ÁèæÂú®„ÅÆËÉåÊôØË®≠ÂÆöÔºàCPUÈÅ∏Êäû„Å´Âøú„Åò„Å¶Â§âÊõ¥Ôºâ
        let currentBackground = null;
        
        // Èü≥Â£∞Ë™≠„Åø‰∏ä„ÅíÈñ¢Êï∞
        function speakRound(roundNumber) {
            const roundNames = ['', '„É©„Ç¶„É≥„Éâ„ÉØ„É≥', '„É©„Ç¶„É≥„Éâ„ÉÑ„Éº', '„É©„Ç¶„É≥„Éâ„Çπ„É™„Éº'];
            if (roundNumber >= 1 && roundNumber <= 3) {
                const utterance = new SpeechSynthesisUtterance(roundNames[roundNumber]);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9; // Â∞ë„Åó„ÇÜ„Å£„Åè„Çä
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                try {
                    window.speechSynthesis.speak(utterance);
                } catch (e) {
                    // Èü≥Â£∞ÂêàÊàê„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
                    console.log('Èü≥Â£∞ÂêàÊàê„Åå‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì');
                }
            }
        }
        
        function initGame() {
            // „É©„Ç¶„É≥„ÉâÂà∂„ÅÆÂàùÊúüÂåñ
            currentRound = 1;
            player1Wins = 0;
            player2Wins = 0;
            roundStarting = true;
            roundStartFrames = 0;
            
            // „Éó„É¨„Ç§„É§„ÉºÂàùÊúüÂåñ
            player1 = new Player(
                canvas.width * 0.25,
                canvas.height - 180,
                { left: 'ArrowLeft', right: 'ArrowRight', up: 'ArrowUp', down: 'ArrowDown', punch: 'KeyM', kick: 'KeyN', special: 'KeyB' },
                selectedP1,
                1
            );
            
            player2 = new Player(
                canvas.width * 0.75,
                canvas.height - 180,
                { left: 'KeyA', right: 'KeyD', up: 'KeyW', down: 'KeyS', punch: 'KeyG', kick: 'KeyH', special: 'KeyJ' },
                selectedP2,
                -1,
                true // CPU„É¢„Éº„Éâ
            );
            
            // ËÉåÊôØË®≠ÂÆöÔºà„Éó„É¨„Ç§„É§„Éº1ÂÅ¥„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„Å´Âøú„Åò„Å¶Ôºâ
            currentBackground = characterData[selectedP1].background;
            
            // UIÊõ¥Êñ∞
            document.getElementById('player1Name').textContent = player1.name;
            document.getElementById('player2Name').textContent = player2.name + ' (CPU)';
            document.getElementById('player1Wins').textContent = player1Wins;
            document.getElementById('player2Wins').textContent = player2Wins;
            document.getElementById('roundInfo').style.display = 'block';
            
            // „É©„Ç¶„É≥„ÉâÈñãÂßã„É°„ÉÉ„Çª„Éº„Ç∏
            roundStartMessage = `ROUND ${currentRound}`;
            document.getElementById('roundText').textContent = roundStartMessage;
            
            // „É©„Ç¶„É≥„ÉâÈñãÂßãÈü≥Â£∞
            speakRound(currentRound);
            
            gameRunning = true;
            gameTime = 99;
            lastTime = Date.now();
            
            // BGMÈñãÂßãÔºà„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂæå„Å´Èü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂæ©ÂÖÉÔºâ
            try {
                initAudioContexts();
                resumeAudioContexts();
                playBGM();
            } catch (e) {
                // Èü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
                console.warn('Èü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÂàùÊúüÂåñ„Ç®„É©„Éº:', e);
            }
            
            gameLoop();
        }
        
        function startNextRound() {
            // Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„ÇíÈñãÂßã
            currentRound++;
            
            // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØÔºàÂÖà„Å´2Âãù„Åó„ÅüÊñπ„ÅåÂãùÂà©Ôºâ
            if (player1Wins >= 2 || player2Wins >= 2) {
                const winner = player1Wins >= 2 ? player1.name : player2.name;
                endGame(winner + ' „ÅÆÂãùÂà©ÔºÅ');
                return;
            }
            
            // ÊúÄÂ§ß„É©„Ç¶„É≥„ÉâÊï∞„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà
            if (currentRound > maxRounds) {
                // ÂãùÂà©Êï∞„ÅåÂ§ö„ÅÑÊñπ„ÅåÂãùÂà©
                if (player1Wins > player2Wins) {
                    endGame(player1.name + ' „ÅÆÂãùÂà©ÔºÅ');
                } else if (player2Wins > player1Wins) {
                    endGame(player2.name + ' „ÅÆÂãùÂà©ÔºÅ');
                } else {
                    endGame('Âºï„ÅçÂàÜ„ÅëÔºÅ');
                }
                return;
            }
            
            // „Ç®„Éï„Çß„ÇØ„Éà„ÅÆ„ÇØ„É™„Ç¢
            particles.length = 0;
            damageNumbers.length = 0;
            criticalTexts.length = 0;
            cameraShake.frames = 0;
            cameraShake.x = 0;
            cameraShake.y = 0;
            slowMotionActive = false;
            
            // „É©„Ç¶„É≥„ÉâÈñãÂßãÂá¶ÁêÜ
            roundStarting = true;
            roundStartFrames = 0;
            roundStartMessage = `ROUND ${currentRound}`;
            document.getElementById('roundText').textContent = roundStartMessage;
            document.getElementById('roundInfo').style.display = 'block';
            
            // „Éó„É¨„Ç§„É§„Éº„Çí„É™„Çª„ÉÉ„Éà
            player1.health = 100;
            player1.guardGauge = 100;
            player1.guardCrushed = false;
            player1.stunned = 0;
            player1.comboCount = 0;
            player1.comboTimer = 0;
            player1.x = canvas.width * 0.25;
            player1.y = canvas.height - 180;
            player1.vx = 0;
            player1.vy = 0;
            player1.isAttacking = false;
            player1.specialAbilityActive = false;
            player1.superMoveActive = false;
            player1.superGauge = 0;
            
            player2.health = 100;
            player2.guardGauge = 100;
            player2.guardCrushed = false;
            player2.stunned = 0;
            player2.comboCount = 0;
            player2.comboTimer = 0;
            player2.x = canvas.width * 0.75;
            player2.y = canvas.height - 180;
            player2.vx = 0;
            player2.vy = 0;
            player2.isAttacking = false;
            player2.specialAbilityActive = false;
            player2.superMoveActive = false;
            player2.superGauge = 0;
            
            // „Çø„Ç§„Éû„Éº„É™„Çª„ÉÉ„Éà
            gameTime = 99;
            lastTime = Date.now();
            
            // „Ç≤„Éº„É†ÂÜçÈñã
            gameRunning = true;
            
            // „É©„Ç¶„É≥„ÉâÈñãÂßãÈü≥Â£∞
            speakRound(currentRound);
            
            // „Ç≤„Éº„É†„É´„Éº„Éó„ÇíÂÜçÈñã
            gameLoop();
        }
        
        function gameLoop() {
            if (!gameRunning) return;
            
            // „É©„Ç¶„É≥„ÉâÈñãÂßãÊºîÂá∫
            if (roundStarting) {
                roundStartFrames++;
                if (roundStartFrames >= 120) { // 2ÁßíÈñìË°®Á§∫
                    roundStarting = false;
                    document.getElementById('roundInfo').style.display = 'none';
                }
                // „É©„Ç¶„É≥„ÉâÈñãÂßã‰∏≠„ÇÇÊèèÁîª„ÅØÁ∂öË°å
                draw();
                requestAnimationFrame(gameLoop);
                return;
            }
            
            // „Çø„Ç§„Éû„ÉºÊõ¥Êñ∞
            const now = Date.now();
            if (now - lastTime >= 1000) {
                gameTime--;
                lastTime = now;
                document.getElementById('timer').textContent = gameTime;
                
                if (gameTime <= 0) {
                    // „Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÊôÇ„ÅÆÂà§ÂÆöÔºà‰ΩìÂäõ„ÅåÂ§ö„ÅÑÊñπ„ÅåÂãùÂà©Ôºâ
                    if (player1.health > player2.health) {
                        player1Wins++;
                        document.getElementById('player1Wins').textContent = player1Wins;
                        setTimeout(() => startNextRound(), 2000);
                    } else if (player2.health > player1.health) {
                        player2Wins++;
                        document.getElementById('player2Wins').textContent = player2Wins;
                        setTimeout(() => startNextRound(), 2000);
                    } else {
                        // Âºï„ÅçÂàÜ„Åë„ÅÆÂ†¥Âêà„ÅØÊ¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å∏
                        setTimeout(() => startNextRound(), 2000);
                    }
                    return;
                }
            }
            
            // „Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥Êõ¥Êñ∞
            if (slowMotionActive) {
                slowMotionFrames--;
                if (slowMotionFrames <= 0) {
                    slowMotionActive = false;
                    slowMotionSpeed = 1.0;
                }
            }
            
            // Êõ¥Êñ∞Âá¶ÁêÜÔºà„Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥ÈÅ©Áî®Ôºâ
            if (!slowMotionActive || slowMotionFrames % Math.round(1 / slowMotionSpeed) === 0) {
            player1.update();
            player2.update();
            }
            
            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´Êõ¥Êñ∞
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }
            
            // „ÉÄ„É°„Éº„Ç∏Êï∞Â≠óÊõ¥Êñ∞
            for (let i = damageNumbers.length - 1; i >= 0; i--) {
                damageNumbers[i].update();
                if (damageNumbers[i].life <= 0) {
                    damageNumbers.splice(i, 1);
                }
            }
            
            // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
            for (let i = criticalTexts.length - 1; i >= 0; i--) {
                criticalTexts[i].update();
                if (criticalTexts[i].life <= 0) {
                    criticalTexts.splice(i, 1);
                }
            }
            
            // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØÊõ¥Êñ∞
            if (cameraShake.frames > 0) {
                cameraShake.frames--;
                const shake = cameraShake.intensity * (cameraShake.frames / 20);
                cameraShake.x = (Math.random() - 0.5) * shake;
                cameraShake.y = (Math.random() - 0.5) * shake;
            } else {
                cameraShake.x = 0;
                cameraShake.y = 0;
            }
            
            // ‰ΩìÂäõ„ÉÅ„Çß„ÉÉ„ÇØÔºàKOÊºîÂá∫Ôºâ
            if (player1.health <= 0) {
                player1.health = 0; // Á¢∫ÂÆü„Å´0„Å´„Åô„Çã
                if (gameRunning) { // ‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°å
                    stopBGM();
                    playKOSound();
                    startSlowMotion(0.2, 60);
                    shakeCamera(20, 30);
                    createKOEffect(player1);
                    
                    // „É©„Ç¶„É≥„ÉâÂãùÂà©Âá¶ÁêÜ
                    player2Wins++;
                    document.getElementById('player2Wins').textContent = player2Wins;
                    
                    setTimeout(() => {
                        playVictorySound();
                        // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                        if (player2Wins >= 2) {
                endGame(player2.name + ' „ÅÆÂãùÂà©ÔºÅ');
                            gameRunning = false;
                        } else {
                            // Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å∏
                            startNextRound();
                        }
                    }, 2000);
                    gameRunning = false;
                }
                return;
            }
            if (player2.health <= 0) {
                player2.health = 0; // Á¢∫ÂÆü„Å´0„Å´„Åô„Çã
                if (gameRunning) { // ‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°å
                    stopBGM();
                    playKOSound();
                    startSlowMotion(0.2, 60);
                    shakeCamera(20, 30);
                    createKOEffect(player2);
                    
                    // „É©„Ç¶„É≥„ÉâÂãùÂà©Âá¶ÁêÜ
                    player1Wins++;
                    document.getElementById('player1Wins').textContent = player1Wins;
                    
                    setTimeout(() => {
                        playVictorySound();
                        // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                        if (player1Wins >= 2) {
                endGame(player1.name + ' „ÅÆÂãùÂà©ÔºÅ');
                            gameRunning = false;
                        } else {
                            // Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å∏
                            startNextRound();
                        }
                    }, 2000);
                    gameRunning = false;
                }
                return;
            }
            
            // ÊèèÁîª
            draw();
            
            // UIÊõ¥Êñ∞
            document.getElementById('player1Health').style.width = player1.health + '%';
            document.getElementById('player2Health').style.width = player2.health + '%';
            
            // „Ç¨„Éº„Éâ„Ç≤„Éº„Ç∏Êõ¥Êñ∞
            const p1GuardPercent = Math.max(0, (player1.guardGauge / player1.maxGuardGauge) * 100);
            const p2GuardPercent = Math.max(0, (player2.guardGauge / player2.maxGuardGauge) * 100);
            document.getElementById('player1Guard').style.width = p1GuardPercent + '%';
            document.getElementById('player2Guard').style.width = p2GuardPercent + '%';
            
            // Ë∂ÖÂøÖÊÆ∫ÊäÄ„Ç≤„Éº„Ç∏Êõ¥Êñ∞
            updateSuperGauge('player1SuperGauge', player1.superGauge);
            updateSuperGauge('player2SuperGauge', player2.superGauge);
            
            // „Ç≥„É≥„ÉúË°®Á§∫Êõ¥Êñ∞
            const p1ComboEl = document.getElementById('player1Combo');
            const p2ComboEl = document.getElementById('player2Combo');
            
            if (player1.comboCount > 1) {
                p1ComboEl.textContent = player1.comboCount + ' HIT COMBO!';
                p1ComboEl.classList.add('active');
            } else {
                p1ComboEl.classList.remove('active');
            }
            
            if (player2.comboCount > 1) {
                p2ComboEl.textContent = player2.comboCount + ' HIT COMBO!';
                p2ComboEl.classList.add('active');
            } else {
                p2ComboEl.classList.remove('active');
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function updateSuperGauge(elementId, gauge) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            const segments = container.querySelectorAll('.super-gauge-segment');
            const gaugeCount = Math.floor(gauge / 100); // „Ç≤„Éº„Ç∏Êï∞Ôºà0-3Ôºâ
            
            segments.forEach((segment, index) => {
                if (index < gaugeCount) {
                    segment.classList.remove('empty');
                } else {
                    segment.classList.add('empty');
                }
            });
        }
        
        function createKOEffect(player) {
            // KO„Ç®„Éï„Çß„ÇØ„ÉàÔºöÁàÜÁô∫ÁöÑ„Å™„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
            for (let i = 0; i < 100; i++) {
                particles.push(new Particle(
                    player.x + player.width / 2,
                    player.y + player.height / 2,
                    '#f00'
                ));
            }
            // KO„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫
            criticalTexts.push(new CriticalText(
                canvas.width / 2,
                canvas.height / 2 - 50,
                'K.O.!'
            ));
        }
        
        function drawBackground() {
            if (!currentBackground) return;
            
            const bg = currentBackground;
            const groundY = canvas.height - 100;
            
            // Á©∫„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ÔºàÁîªÈù¢ÂÖ®‰Ωì„Çí„Ç´„Éê„ÉºÔºâ
            const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.7);
            bg.sky.forEach((color, index) => {
                skyGradient.addColorStop(index / (bg.sky.length - 1), color);
            });
            ctx.fillStyle = skyGradient;
            // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ„ÇíËÄÉÊÖÆ„Åó„Å¶„ÄÅ„Çà„ÇäÂ∫É„ÅÑÁØÑÂõ≤„ÇíÊèèÁîª
            ctx.fillRect(-Math.abs(cameraShake.x) - 50, -Math.abs(cameraShake.y) - 50, 
                         canvas.width + Math.abs(cameraShake.x) * 2 + 100, 
                         canvas.height * 0.7 + Math.abs(cameraShake.y) + 100);
            
            // Âª∫Áâ©„ÇÑËÉåÊôØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºà„ÉÜ„Éº„Éû„Å´Âøú„Åò„Å¶Ôºâ
            switch(bg.theme) {
                case 'futuristic_city':
                    // Êú™Êù•ÈÉΩÂ∏Ç„ÅÆÂª∫Áâ©
                    for (let i = 0; i < 5; i++) {
                        const x = (i * canvas.width / 5) - (cameraShake.x * 0.1);
                        const height = 100 + Math.sin(i) * 40;
                        ctx.fillStyle = bg.buildings[i % bg.buildings.length];
                        ctx.fillRect(x, canvas.height * 0.7 - height, canvas.width / 6, height);
                        
                        // Á™ìÔºàÂõ∫ÂÆö‰ΩçÁΩÆ„ÅßÊèèÁîªÔºâ
                        ctx.fillStyle = 'rgba(255, 255, 100, 0.8)';
                        for (let w = 0; w < 3; w++) {
                            for (let h = 0; h < Math.floor(height / 30); h++) {
                                const seed = (i * 100) + (w * 10) + h;
                                if (seed % 10 > 3) { // Âõ∫ÂÆö„ÅÆÊù°‰ª∂„ÅßË°®Á§∫
                                    ctx.fillRect(x + 10 + w * 20, canvas.height * 0.7 - height + 10 + h * 30, 8, 10);
                                }
                            }
                        }
                    }
                    break;
                    
                case 'cyberpunk':
                    // „Çµ„Ç§„Éê„Éº„Éë„É≥„ÇØÈ¢®„ÅÆÂª∫Áâ©
                    for (let i = 0; i < 4; i++) {
                        const x = (i * canvas.width / 4) - (cameraShake.x * 0.15);
                        const height = 120 + Math.sin(i * 2) * 50;
                        ctx.fillStyle = bg.buildings[i % bg.buildings.length];
                        ctx.fillRect(x, canvas.height * 0.7 - height, canvas.width / 5, height);
                        
                        // „Éç„Ç™„É≥„É©„Ç§„É≥
                        ctx.strokeStyle = bg.buildings[0];
            ctx.lineWidth = 2;
                ctx.beginPath();
                        ctx.moveTo(x, canvas.height * 0.7 - height);
                        ctx.lineTo(x + canvas.width / 5, canvas.height * 0.7 - height);
                ctx.stroke();
            }
                    break;
                    
                case 'rocky_mountain':
                    // Â≤©Â±±
                    ctx.fillStyle = bg.buildings[0];
                    const mountainPoints = [];
                    for (let i = 0; i <= 10; i++) {
                        const x = (i * canvas.width / 10) - cameraShake.x * 0.05;
                        // Âõ∫ÂÆö„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà„Çí‰ΩøÁî®ÔºàMath.random()„ÅÆ‰ª£„Çè„Çä„Å´Âõ∫ÂÆöÂÄ§Ôºâ
                        const fixedOffset = (i % 3) * 7 - 7; // -7, 0, 7„ÇíÁπ∞„ÇäËøî„Åô
                        const y = canvas.height * 0.7 - 80 - Math.sin(i * 0.5) * 40 + fixedOffset;
                        mountainPoints.push({x, y});
                    }
                    ctx.beginPath();
                    ctx.moveTo(mountainPoints[0].x, canvas.height * 0.7);
                    mountainPoints.forEach(p => ctx.lineTo(p.x, p.y));
                    ctx.lineTo(mountainPoints[mountainPoints.length - 1].x, canvas.height * 0.7);
                    ctx.closePath();
                    ctx.fill();
                    break;
                    
                case 'magical_forest':
                    // È≠îÊ≥ï„ÅÆÊ£Æ„ÅÆÊú®
                    for (let i = 0; i < 6; i++) {
                        const x = (i * canvas.width / 6) - cameraShake.x * 0.08;
                        const trunkHeight = 60 + Math.sin(i) * 20;
                        const trunkWidth = 15;
                        
                        // Âππ
                        ctx.fillStyle = bg.buildings[2];
                        ctx.fillRect(x - trunkWidth/2, canvas.height * 0.7 - trunkHeight, trunkWidth, trunkHeight);
                        
                        // ËëâÔºà‰∏∏Ôºâ
                        ctx.fillStyle = bg.buildings[1];
                        ctx.beginPath();
                        ctx.arc(x, canvas.height * 0.7 - trunkHeight, 30 + Math.sin(i * 2) * 10, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // ÂÖâ„ÇãÂäπÊûúÔºàÊØé„Éï„É¨„Éº„É†Âêå„Åò‰ΩçÁΩÆ„Å´Ë°®Á§∫„Åô„Çã„Åü„ÇÅ„ÄÅÂõ∫ÂÆöÂÄ§„Çí‰ΩøÁî®Ôºâ
                        const seed = i * 7; // Âõ∫ÂÆö„Ç∑„Éº„ÉâÂÄ§
                        if ((seed % 10) > 3) {
                            ctx.save();
                            ctx.fillStyle = bg.buildings[0];
                            ctx.globalAlpha = 0.5;
                            const lightX = x + (seed % 20) - 10;
                            const lightY = canvas.height * 0.7 - trunkHeight - 20 + ((seed * 3) % 20) - 10;
                            ctx.beginPath();
                            ctx.arc(lightX, lightY, 3, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.restore();
                        }
                    }
                    break;
                    
                case 'peaceful_temple':
                    // ÂØ∫Èô¢È¢®„ÅÆÂª∫Áâ©
                    for (let i = 0; i < 3; i++) {
                        const x = (i * canvas.width / 3) - cameraShake.x * 0.1;
                        const height = 90;
                        ctx.fillStyle = bg.buildings[i % bg.buildings.length];
                        ctx.fillRect(x, canvas.height * 0.7 - height, canvas.width / 4, height);
                        
                        // Â±ãÊ†πÔºà‰∏âËßíÔºâ
                        ctx.beginPath();
                        ctx.moveTo(x - 20, canvas.height * 0.7 - height);
                        ctx.lineTo(x + canvas.width / 8, canvas.height * 0.7 - height - 30);
                        ctx.lineTo(x + canvas.width / 4 + 20, canvas.height * 0.7 - height);
                        ctx.closePath();
                        ctx.fillStyle = bg.buildings[1];
                        ctx.fill();
                    }
                    break;
                    
                case 'cosmic_arena':
                    // ÂÆáÂÆô„Ç¢„É™„Éº„ÉäÔºàÊòü„Å®ÊòüÈõ≤Ôºâ- Âõ∫ÂÆö‰ΩçÁΩÆ„ÅßÊèèÁîª
                    for (let i = 0; i < 30; i++) {
                        // Âõ∫ÂÆö„ÅÆ‰ΩçÁΩÆË®àÁÆóÔºàÁñë‰ºº‰π±Êï∞Ôºâ
                        const seedX = (i * 137.5) % canvas.width; // ÈªÑÈáëÊØî„Çí‰Ωø„Å£„ÅüÂàÜÂ∏É
                        const seedY = (i * 97.3) % (canvas.height * 0.7);
                        const x = seedX - cameraShake.x * 0.2;
                        const y = seedY;
                        const alpha = 0.3 + ((i * 0.1) % 0.7);
                        const size = 1 + ((i % 3) * 0.5);
                        
                        ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                        ctx.beginPath();
                        ctx.arc(x, y, size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // ÊòüÈõ≤„Ç®„Éï„Çß„ÇØ„Éà
                    ctx.save();
                    ctx.fillStyle = bg.buildings[0];
                    ctx.globalAlpha = 0.3;
                    for (let i = 0; i < 3; i++) {
                        const x = (i * canvas.width / 3) - cameraShake.x * 0.15;
                        ctx.beginPath();
                        ctx.arc(x, canvas.height * 0.3, 80 + Math.sin(i) * 30, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    ctx.restore();
                    break;
            }
            
            // Âú∞Èù¢ÔºàÁîªÈù¢ÂÖ®‰Ωì„ÇíÂ°ó„Çä„Å§„Å∂„Åó„Å¶„ÄÅÂú∞Èù¢„ÅÆ‰ΩçÁΩÆ„ÇíÊ≠£Á¢∫„Å´ÊèèÁîªÔºâ
            ctx.fillStyle = bg.ground;
            // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ„ÇíËÄÉÊÖÆ„Åó„Å¶Â∫É„ÇÅ„Å´ÊèèÁîª
            const groundWidth = canvas.width + Math.abs(cameraShake.x) * 2 + 100;
            const groundHeight = canvas.height - groundY + Math.abs(cameraShake.y) + 50;
            ctx.fillRect(-Math.abs(cameraShake.x) - 50, groundY, groundWidth, groundHeight);
            
            // Âú∞Èù¢„ÅÆ„ÉÜ„ÇØ„Çπ„ÉÅ„É£Ôºà„ÉÜ„Éº„Éû„Å´Âøú„Åò„Å¶Ôºâ
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            const startX = -Math.abs(cameraShake.x) - 50;
            for (let i = 0; i < groundWidth; i += 30) {
                ctx.beginPath();
                ctx.moveTo(startX + i, groundY);
                ctx.lineTo(startX + i + 20, groundY);
                ctx.stroke();
            }
        }
        
        function draw() {
            // ÁîªÈù¢„Çí„ÇØ„É™„Ç¢ÔºàÊÆãÂÉè„ÇíÈò≤„ÅêÔºâ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            
            // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØÈÅ©Áî®
            ctx.translate(cameraShake.x, cameraShake.y);
            
            // ËÉåÊôØÊèèÁîª
            drawBackground();
            
            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´
            particles.forEach(p => p.draw());
            
            // „Éó„É¨„Ç§„É§„Éº
            player1.draw();
            player2.draw();
            
            // „ÉÄ„É°„Éº„Ç∏Êï∞Â≠ó
            damageNumbers.forEach(dn => dn.draw());
            
            // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÉÜ„Ç≠„Çπ„Éà
            criticalTexts.forEach(ct => ct.draw());
            
            ctx.restore();
            
            // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•ÔºàË∂ÖÂøÖÊÆ∫ÊäÄÁô∫ÂãïÊôÇÔºâ
            if (screenFlash.active) {
                ctx.save();
                const alpha = screenFlash.frames / 10;
                ctx.fillStyle = screenFlash.color;
                ctx.globalAlpha = alpha * 0.5;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
                
                screenFlash.frames--;
                if (screenFlash.frames <= 0) {
                    screenFlash.active = false;
                }
            }
            
            // „É©„Ç¶„É≥„ÉâÈñãÂßãÊºîÂá∫„ÅÆÊèèÁîª
            if (roundStarting) {
                ctx.save();
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#ff0';
                ctx.lineWidth = 4;
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const scale = Math.min(1.0, roundStartFrames / 30);
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.scale(scale, scale);
                ctx.strokeText(roundStartMessage, 0, -20);
                ctx.fillText(roundStartMessage, 0, -20);
                ctx.restore();
                
                ctx.restore();
            }
        }
        
        function endGame(message) {
            gameRunning = false;
            document.getElementById('winnerText').textContent = message;
            document.getElementById('winMethod').textContent = 
                gameTime <= 0 ? '„Çø„Ç§„É†„Ç¢„ÉÉ„Éó' : 'K.O.';
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•Âäõ
        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });
        
        // „É¢„Éê„Ç§„É´„Ç≥„É≥„Éà„É≠„Éº„É´Ôºà„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Áî®Ôºâ
        const mobileControls = {
            p1Punch: 'KeyM',
            p1Kick: 'KeyN',
            p1Special: 'KeyB'
        };
        
        // ÂÜÜÂΩ¢„Ç≥„É≥„Éà„É≠„Éº„É©„ÉºÔºà„Ç¢„Éä„É≠„Ç∞„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÈ¢®Ôºâ„ÅÆÂÆüË£Ö
        function initCircularController(controllerId) {
            const controller = document.getElementById(controllerId);
            if (!controller) return;
            
            const base = controller.querySelector('.circular-controller-base');
            const stick = controller.querySelector('.circular-controller-stick');
            if (!base || !stick) return;
            
            const rect = base.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const radius = rect.width / 2 - 10; // „Éû„Éº„Ç∏„É≥„ÇíËÄÉÊÖÆ
            
            let isActive = false;
            let currentKeys = {
                'ArrowUp': false,
                'ArrowDown': false,
                'ArrowLeft': false,
                'ArrowRight': false
            };
            
            function getTouchPos(e) {
                const touch = e.touches ? e.touches[0] : e;
                return {
                    x: touch.clientX,
                    y: touch.clientY
                };
            }
            
            function updateStickPosition(dx, dy, distance) {
                const maxDistance = radius - 30; // „Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅÆÂçäÂæÑ„ÇíËÄÉÊÖÆ
                const clampedDistance = Math.min(distance, maxDistance);
                
                if (clampedDistance > 5) { // „Éá„ÉÉ„Éâ„Çæ„Éº„É≥
                    const angle = Math.atan2(dy, dx);
                    const x = Math.cos(angle) * clampedDistance;
                    const y = Math.sin(angle) * clampedDistance;
                    
                    stick.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                    
                    // 8ÊñπÂêëÂÖ•Âäõ„ÅÆÂà§ÂÆöÔºàËßíÂ∫¶„Åã„ÇâÊñπÂêë„ÇíÊ±∫ÂÆöÔºâ
                    const angleDeg = (angle * 180 / Math.PI + 360) % 360;
                    const directions = {
                        'ArrowUp': (angleDeg >= 45 && angleDeg < 135),
                        'ArrowDown': (angleDeg >= 225 && angleDeg < 315),
                        'ArrowLeft': (angleDeg >= 135 && angleDeg < 225),
                        'ArrowRight': (angleDeg >= 315 || angleDeg < 45)
                    };
                    
                    // Êñú„ÇÅÊñπÂêë„ÅÆÂá¶ÁêÜ
                    if (Math.abs(dx) > Math.abs(dy) * 0.5 && Math.abs(dy) > Math.abs(dx) * 0.5) {
                        // Êñú„ÇÅÊñπÂêë
                        if (dy < 0 && dx < 0) {
                            // Â∑¶‰∏ä
                            directions['ArrowUp'] = true;
                            directions['ArrowLeft'] = true;
                        } else if (dy < 0 && dx > 0) {
                            // Âè≥‰∏ä
                            directions['ArrowUp'] = true;
                            directions['ArrowRight'] = true;
                        } else if (dy > 0 && dx < 0) {
                            // Â∑¶‰∏ã
                            directions['ArrowDown'] = true;
                            directions['ArrowLeft'] = true;
                        } else if (dy > 0 && dx > 0) {
                            // Âè≥‰∏ã
                            directions['ArrowDown'] = true;
                            directions['ArrowRight'] = true;
                        }
                    }
                    
                    // „Ç≠„Éº„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                    Object.keys(directions).forEach(key => {
                        if (directions[key] !== currentKeys[key]) {
                            currentKeys[key] = directions[key];
                            keys[key] = directions[key];
                        }
                    });
                } else {
                    // ‰∏≠ÂøÉ„Å´Êàª„Åô
                    stick.style.transform = 'translate(-50%, -50%)';
                    Object.keys(currentKeys).forEach(key => {
                        if (currentKeys[key]) {
                            currentKeys[key] = false;
                            keys[key] = false;
                        }
                    });
                }
            }
            
            function handleStart(e) {
                e.preventDefault();
                e.stopPropagation();
                isActive = true;
                controller.classList.add('active');
                
                const pos = getTouchPos(e);
                const rect = base.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const dx = pos.x - centerX;
                const dy = pos.y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                updateStickPosition(dx, dy, distance);
            }
            
            function handleMove(e) {
                if (!isActive) return;
                e.preventDefault();
                e.stopPropagation();
                
                const pos = getTouchPos(e);
                const rect = base.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const dx = pos.x - centerX;
                const dy = pos.y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                updateStickPosition(dx, dy, distance);
            }
            
            function handleEnd(e) {
                if (!isActive) return;
                e.preventDefault();
                e.stopPropagation();
                
                isActive = false;
                controller.classList.remove('active');
                stick.style.transform = 'translate(-50%, -50%)';
                
                // „Åô„Åπ„Å¶„ÅÆ„Ç≠„Éº„Çí„É™„Çª„ÉÉ„Éà
                Object.keys(currentKeys).forEach(key => {
                    currentKeys[key] = false;
                    keys[key] = false;
                });
            }
            
            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà
            base.addEventListener('touchstart', handleStart, { passive: false });
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd, { passive: false });
            document.addEventListener('touchcancel', handleEnd, { passive: false });
            
            // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„ÉàÔºà„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÂØæÂøúÔºâ
            base.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);
        }
        
        // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÉºÔºà„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Áî®Ôºâ
        function handleTouchStart(e, key) {
            e.preventDefault();
            e.stopPropagation();
            keys[key] = true;
            
            const target = e.currentTarget;
            target.classList.add('touching');
        }
        
        function handleTouchEnd(e, key) {
            e.preventDefault();
            e.stopPropagation();
            keys[key] = false;
            
            const target = e.currentTarget;
            target.classList.remove('touching');
        }
        
        function handleTouchCancel(e, key) {
            e.preventDefault();
            e.stopPropagation();
            keys[key] = false;
            
            const target = e.currentTarget;
            target.classList.remove('touching');
        }
        
        function handleMouseDown(e, key) {
            e.preventDefault();
            keys[key] = true;
            e.currentTarget.classList.add('touching');
        }
        
        function handleMouseUp(e, key) {
            e.preventDefault();
            keys[key] = false;
            e.currentTarget.classList.remove('touching');
        }
        
        function handleMouseLeave(e, key) {
            keys[key] = false;
            e.currentTarget.classList.remove('touching');
        }
        
        // „É¢„Éê„Ç§„É´„Ç≥„É≥„Éà„É≠„Éº„É©„ÅÆÂàùÊúüÂåñ
        // ÂÜÜÂΩ¢„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„ÅÆÂàùÊúüÂåñ
        initCircularController('p1CircularController');
        
        // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÂàùÊúüÂåñ
        Object.keys(mobileControls).forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) {
                const key = mobileControls[btnId];
                
                btn.addEventListener('touchstart', (e) => handleTouchStart(e, key), { passive: false });
                btn.addEventListener('touchend', (e) => handleTouchEnd(e, key), { passive: false });
                btn.addEventListener('touchcancel', (e) => handleTouchCancel(e, key), { passive: false });
                
                btn.addEventListener('mousedown', (e) => handleMouseDown(e, key));
                btn.addEventListener('mouseup', (e) => handleMouseUp(e, key));
                btn.addEventListener('mouseleave', (e) => handleMouseLeave(e, key));
            }
        });
        
        // ÁîªÈù¢Â§ñ„Çø„ÉÉ„ÉÅÊôÇ„ÅÆÂá¶ÁêÜÔºàiOSÂØæÂøúÔºâ
        document.addEventListener('touchmove', (e) => {
            if (e.target === canvas || e.target.closest('.mobile-controls')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchstart', (e) => {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
